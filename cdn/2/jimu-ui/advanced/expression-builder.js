System.register(["jimu-core","jimu-core/react","jimu-core/react-dom/server","jimu-for-builder","jimu-layouts/layout-runtime","jimu-theme","jimu-ui"],(function(e,t){var s={},n={},r={},i={},o={},a={},l={};return Object.defineProperty(n,"__esModule",{value:!0}),{setters:[function(e){s.ArcadeContentCapability=e.ArcadeContentCapability,s.ArcadeProfileContextProvider=e.ArcadeProfileContextProvider,s.ArcadeProfileType=e.ArcadeProfileType,s.CONSTANTS=e.CONSTANTS,s.DataSourceManager=e.DataSourceManager,s.DynamicStyleType=e.DynamicStyleType,s.ExpressionFunctions=e.ExpressionFunctions,s.ExpressionPartType=e.ExpressionPartType,s.Immutable=e.Immutable,s.JimuFieldType=e.JimuFieldType,s.LayoutItemType=e.LayoutItemType,s.MultipleDataSourceComponent=e.MultipleDataSourceComponent,s.React=e.React,s.ReactRedux=e.ReactRedux,s.arcadeContentUtils=e.arcadeContentUtils,s.classNames=e.classNames,s.css=e.css,s.expressionUtils=e.expressionUtils,s.focusElementInKeyboardMode=e.focusElementInKeyboardMode,s.getAppStore=e.getAppStore,s.groupExpressionPartsByFunction=e.groupExpressionPartsByFunction,s.hooks=e.hooks,s.i18n=e.i18n,s.indexedDBUtils=e.indexedDBUtils,s.injectIntl=e.injectIntl,s.jsx=e.jsx,s.loadArcGISJSAPIModule=e.loadArcGISJSAPIModule,s.moduleLoader=e.moduleLoader,s.polished=e.polished,s.urlUtils=e.urlUtils,s.uuidv1=e.uuidv1},function(e){Object.keys(e).forEach((function(t){n[t]=e[t]}))},function(e){r.renderToStaticMarkup=e.renderToStaticMarkup},function(e){i.helpUtils=e.helpUtils},function(e){o.searchUtils=e.searchUtils},function(e){a.getTheme=e.getTheme,a.getTheme2=e.getTheme2,a.registerStyles=e.registerStyles,a.withStyles=e.withStyles,a.withTheme=e.withTheme},function(e){l.Alert=e.Alert,l.Button=e.Button,l.Checkbox=e.Checkbox,l.Dropdown=e.Dropdown,l.DropdownButton=e.DropdownButton,l.DropdownItem=e.DropdownItem,l.DropdownMenu=e.DropdownMenu,l.Icon=e.Icon,l.Label=e.Label,l.Loading=e.Loading,l.LoadingType=e.LoadingType,l.Modal=e.Modal,l.ModalBody=e.ModalBody,l.ModalFooter=e.ModalFooter,l.ModalHeader=e.ModalHeader,l.NumericInput=e.NumericInput,l.Option=e.Option,l.Popper=e.Popper,l.Select=e.Select,l.Switch=e.Switch,l.Tab=e.Tab,l.Tabs=e.Tabs,l.TextArea=e.TextArea,l.TextInput=e.TextInput,l.Tooltip=e.Tooltip,l.defaultMessages=e.defaultMessages}],execute:function(){e((()=>{var e={1888:e=>{"use strict";e.exports=a},2694:(e,t,s)=>{"use strict";var n=s(6925);function r(){}function i(){}i.resetWarningCache=r,e.exports=function(){function e(e,t,s,r,i,o){if(o!==n){var a=new Error("Calling PropTypes validators directly is not supported by the `prop-types` package. Use PropTypes.checkPropTypes() to call them. Read more at http://fb.me/use-check-prop-types");throw a.name="Invariant Violation",a}}function t(){return e}e.isRequired=e;var s={array:e,bigint:e,bool:e,func:e,number:e,object:e,string:e,symbol:e,any:e,arrayOf:t,element:e,elementType:e,instanceOf:t,node:e,objectOf:t,oneOf:t,oneOfType:t,shape:t,exact:t,checkPropTypes:i,resetWarningCache:r};return s.PropTypes=s,s}},3637:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 16 16"><path fill="#000" fill-rule="evenodd" d="M2.616 1.68a9.87 9.87 0 0 0 0 12.64l.768-.64a8.87 8.87 0 0 1 0-11.36zm10.768 12.64a9.87 9.87 0 0 0 0-12.64l-.768.64a8.87 8.87 0 0 1 0 11.36zM8.915 8h1V6.366l1.415.817.5-.866-1.415-.817 1.415-.817-.5-.866-1.415.817V3h-1v1.634L7.5 3.817l-.5.866 1.415.817L7 6.317l.5.866 1.415-.817zM5 13a1 1 0 1 0 0-2 1 1 0 0 0 0 2" clip-rule="evenodd"></path></svg>'},3800:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 16 16"><path fill="#000" d="M0 0h16v16H0z" opacity=".01"></path><path fill="#000" fill-rule="evenodd" d="m9.603 3-4.175 9.642.97.358 4.174-9.642zm1.897 8.233-.738-.681L13.524 8l-2.762-2.552.738-.681L15 8zm-7-6.466.738.681L2.476 8l2.762 2.552-.738.681L1 8z" clip-rule="evenodd"></path></svg>'},4108:e=>{"use strict";e.exports=i},5556:(e,t,s)=>{e.exports=s(2694)()},6925:e=>{"use strict";e.exports="SECRET_DO_NOT_PASS_THIS_OR_YOU_WILL_BE_FIRED"},14321:e=>{"use strict";e.exports=l},17123:function(e,t,s){"use strict";var n,r=this&&this.__extends||(n=function(e,t){return n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&(e[s]=t[s])},n(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function s(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(s.prototype=t.prototype,new s)}),i=this&&this.__assign||function(){return i=Object.assign||function(e){for(var t,s=1,n=arguments.length;s<n;s++)for(var r in t=arguments[s])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e},i.apply(this,arguments)},o=this&&this.__createBinding||(Object.create?function(e,t,s,n){void 0===n&&(n=s);var r=Object.getOwnPropertyDescriptor(t,s);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[s]}}),Object.defineProperty(e,n,r)}:function(e,t,s,n){void 0===n&&(n=s),e[n]=t[s]}),a=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),l=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&o(t,e,s);return a(t,e),t},p=this&&this.__rest||function(e,t){var s={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(s[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(n=Object.getOwnPropertySymbols(e);r<n.length;r++)t.indexOf(n[r])<0&&Object.prototype.propertyIsEnumerable.call(e,n[r])&&(s[n[r]]=e[n[r]])}return s},c=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});var d=l(s(68972)),u=c(s(32017)),h=l(s(5556));function m(e){return e&&e.replace(/&nbsp;|\u202F|\u00A0/g," ").replace(/<br \/>/g,"<br>")}var g=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.lastHtml=t.props.html,t.el="function"==typeof t.props.innerRef?{current:null}:d.createRef(),t.getEl=function(){return(t.props.innerRef&&"function"!=typeof t.props.innerRef?t.props.innerRef:t.el).current},t.emitChange=function(e){var s=t.getEl();if(s){var n=s.innerHTML;if(t.props.onChange&&n!==t.lastHtml){var r=Object.assign({},e,{target:{value:n}});t.props.onChange(r)}t.lastHtml=n}},t}return r(t,e),t.prototype.render=function(){var e=this,t=this.props,s=t.tagName,n=t.html,r=t.innerRef,o=p(t,["tagName","html","innerRef"]);return d.createElement(s||"div",i(i({},o),{ref:"function"==typeof r?function(t){r(t),e.el.current=t}:r||this.el,onInput:this.emitChange,onBlur:this.props.onBlur||this.emitChange,onKeyUp:this.props.onKeyUp||this.emitChange,onKeyDown:this.props.onKeyDown||this.emitChange,contentEditable:!this.props.disabled,dangerouslySetInnerHTML:{__html:n}}),this.props.children)},t.prototype.shouldComponentUpdate=function(e){var t=this.props,s=this.getEl();return!s||(m(e.html)!==m(s.innerHTML)||(t.disabled!==e.disabled||t.tagName!==e.tagName||t.className!==e.className||t.innerRef!==e.innerRef||t.placeholder!==e.placeholder||!(0,u.default)(t.style,e.style)))},t.prototype.componentDidUpdate=function(){var e=this.getEl();e&&(this.props.html!==e.innerHTML&&(e.innerHTML=this.props.html),this.lastHtml=this.props.html,function(e){var t=document.createTextNode("");e.appendChild(t);var s=document.activeElement===e;if(null!==t&&null!==t.nodeValue&&s){var n=window.getSelection();if(null!==n){var r=document.createRange();r.setStart(t,t.nodeValue.length),r.collapse(!0),n.removeAllRanges(),n.addRange(r)}e instanceof HTMLElement&&e.focus()}}(e))},t.propTypes={html:h.string.isRequired,onChange:h.func,disabled:h.bool,tagName:h.string,className:h.string,style:h.object,innerRef:h.oneOfType([h.object,h.func])},t}(d.Component);t.default=g},23662:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 16 16"><path fill="#000" d="M7.5 0a.5.5 0 0 0-.5.5V7H.5a.5.5 0 0 0 0 1H7v6.5a.5.5 0 0 0 1 0V8h6.5a.5.5 0 0 0 0-1H8V.5a.5.5 0 0 0-.5-.5"></path></svg>'},28938:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 16 16"><path fill="#000" fill-rule="evenodd" d="M9.707 1H2v14h1V2h6.293L12 4.707V14H5v1h8V4.293zM5 5h4V4H5zm6 3H5V7h6zm-6 3h4v-1H5z" clip-rule="evenodd"></path></svg>'},28996:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 16 16"><path fill="#000" fill-rule="evenodd" d="M8 2.125 14.334 14H1.667zm-.882-.47a1 1 0 0 1 1.765 0l6.333 11.874A1 1 0 0 1 14.334 15H1.667a1 1 0 0 1-.882-1.47zM8 4.874a.905.905 0 0 0-.9.995l.35 3.507a.552.552 0 0 0 1.1 0L8.9 5.87a.905.905 0 0 0-.9-.995m1 7a1 1 0 1 1-2 0 1 1 0 0 1 2 0" clip-rule="evenodd"></path></svg>'},30655:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 16 16"><path fill="#000" fill-rule="evenodd" d="M2.146 4.653a.485.485 0 0 1 .708 0L8 10.24l5.146-5.587a.485.485 0 0 1 .708 0 .54.54 0 0 1 0 .738l-5.5 5.956a.485.485 0 0 1-.708 0l-5.5-5.956a.54.54 0 0 1 0-.738" clip-rule="evenodd"></path></svg>'},32017:e=>{"use strict";e.exports=function e(t,s){if(t===s)return!0;if(t&&s&&"object"==typeof t&&"object"==typeof s){if(t.constructor!==s.constructor)return!1;var n,r,i;if(Array.isArray(t)){if((n=t.length)!=s.length)return!1;for(r=n;0!=r--;)if(!e(t[r],s[r]))return!1;return!0}if(t.constructor===RegExp)return t.source===s.source&&t.flags===s.flags;if(t.valueOf!==Object.prototype.valueOf)return t.valueOf()===s.valueOf();if(t.toString!==Object.prototype.toString)return t.toString()===s.toString();if((n=(i=Object.keys(t)).length)!==Object.keys(s).length)return!1;for(r=n;0!=r--;)if(!Object.prototype.hasOwnProperty.call(s,i[r]))return!1;for(r=n;0!=r--;){var o=i[r];if(!e(t[o],s[o]))return!1}return!0}return t!=t&&s!=s}},41496:e=>{"use strict";e.exports=o},42018:(e,t,s)=>{"use strict";s.d(t,{ArcadeContentBuilderPopup:()=>ee});var n=s(79244),r=s(14321),i=s(1888),o=s(4108),a=s(28996),l=s.n(a),p=function(e,t){var s={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(s[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(n=Object.getOwnPropertySymbols(e);r<n.length;r++)t.indexOf(n[r])<0&&Object.prototype.propertyIsEnumerable.call(e,n[r])&&(s[n[r]]=e[n[r]])}return s};const c=e=>{const t=window.SVG,{className:s}=e,r=p(e,["className"]),i=(0,n.classNames)("jimu-icon jimu-icon-component",s);return t?n.React.createElement(t,Object.assign({className:i,src:l()},r)):n.React.createElement("svg",Object.assign({className:i},r))};var d=s(98657),u=s.n(d),h=function(e,t){var s={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(s[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(n=Object.getOwnPropertySymbols(e);r<n.length;r++)t.indexOf(n[r])<0&&Object.prototype.propertyIsEnumerable.call(e,n[r])&&(s[n[r]]=e[n[r]])}return s};const m=e=>{const t=window.SVG,{className:s}=e,r=h(e,["className"]),i=(0,n.classNames)("jimu-icon jimu-icon-component",s);return t?n.React.createElement(t,Object.assign({className:i,src:u()},r)):n.React.createElement("svg",Object.assign({className:i},r))};var g=s(45508),x=s.n(g),f=function(e,t){var s={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(s[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(n=Object.getOwnPropertySymbols(e);r<n.length;r++)t.indexOf(n[r])<0&&Object.prototype.propertyIsEnumerable.call(e,n[r])&&(s[n[r]]=e[n[r]])}return s};const y=e=>{const t=window.SVG,{className:s}=e,r=f(e,["className"]),i=(0,n.classNames)("jimu-icon jimu-icon-component",s);return t?n.React.createElement(t,Object.assign({className:i,src:x()},r)):n.React.createElement("svg",Object.assign({className:i},r))};var v=s(23662),b=s.n(v),S=function(e,t){var s={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(s[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(n=Object.getOwnPropertySymbols(e);r<n.length;r++)t.indexOf(n[r])<0&&Object.prototype.propertyIsEnumerable.call(e,n[r])&&(s[n[r]]=e[n[r]])}return s};const E=e=>{const t=window.SVG,{className:s}=e,r=S(e,["className"]),i=(0,n.classNames)("jimu-icon jimu-icon-component",s);return t?n.React.createElement(t,Object.assign({className:i,src:b()},r)):n.React.createElement("svg",Object.assign({className:i},r))};var C=s(94064),I=s.n(C),w=function(e,t){var s={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(s[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(n=Object.getOwnPropertySymbols(e);r<n.length;r++)t.indexOf(n[r])<0&&Object.prototype.propertyIsEnumerable.call(e,n[r])&&(s[n[r]]=e[n[r]])}return s};const N=e=>{const t=window.SVG,{className:s}=e,r=w(e,["className"]),i=(0,n.classNames)("jimu-icon jimu-icon-component",s);return t?n.React.createElement(t,Object.assign({className:i,src:I()},r)):n.React.createElement("svg",Object.assign({className:i},r))};var O=s(30655),T=s.n(O),j=function(e,t){var s={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(s[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(n=Object.getOwnPropertySymbols(e);r<n.length;r++)t.indexOf(n[r])<0&&Object.prototype.propertyIsEnumerable.call(e,n[r])&&(s[n[r]]=e[n[r]])}return s};const D=e=>{const t=window.SVG,{className:s}=e,r=j(e,["className"]),i=(0,n.classNames)("jimu-icon jimu-icon-component",s);return t?n.React.createElement(t,Object.assign({className:i,src:T()},r)):n.React.createElement("svg",Object.assign({className:i},r))};var P=s(62838),F=s.n(P),R=function(e,t){var s={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(s[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(n=Object.getOwnPropertySymbols(e);r<n.length;r++)t.indexOf(n[r])<0&&Object.prototype.propertyIsEnumerable.call(e,n[r])&&(s[n[r]]=e[n[r]])}return s};const M=e=>{const t=window.SVG,{className:s}=e,r=R(e,["className"]),i=(0,n.classNames)("jimu-icon jimu-icon-component",s);return t?n.React.createElement(t,Object.assign({className:i,src:F()},r)):n.React.createElement("svg",Object.assign({className:i},r))};var A=s(72259),k=s.n(A),_=function(e,t){var s={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(s[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(n=Object.getOwnPropertySymbols(e);r<n.length;r++)t.indexOf(n[r])<0&&Object.prototype.propertyIsEnumerable.call(e,n[r])&&(s[n[r]]=e[n[r]])}return s};const $=e=>{const t=window.SVG,{className:s}=e,r=_(e,["className"]),i=(0,n.classNames)("jimu-icon jimu-icon-component",s);return t?n.React.createElement(t,Object.assign({className:i,src:k()},r)):n.React.createElement("svg",Object.assign({className:i},r))},B=n.css`
  display: flex;
  flex-direction: column;
  .icons-body {
    overflow: auto;
  }

  .text-input-and-icon-picker {
    width: calc(100% - 16px);
  }
`;const L=(0,i.withTheme)((0,n.injectIntl)((function(e){const t=e.inModal,s=e.expand,i=e.icons,o=n.React.useMemo((()=>{let e=null;return e=(null==i?void 0:i.length)>0?i:(0,n.Immutable)([]),e=e.filter((e=>!!e)),e}),[i]),a=e.onExpandChange,l=e.onClose,p=e.onIconsChange,[c,d]=n.hooks.useLoadedModule("jimu-ui/advanced/setting-components"),u=c&&d?d.SettingRow:null,[h,m]=n.hooks.useLoadedModule("jimu-ui/advanced/resource-selector"),g=m?m.IconPicker:null,x=c&&u&&h&&g,f=n.hooks.useTranslation(r.defaultMessages),y=f("icons"),v=f("add"),b=f("collapse"),S=f("expand"),C=f("close"),I=f("name"),w=f("icon"),O=f("remove"),T=f("duplicatedLabel"),j=n.React.useCallback((e=>{p&&p(e)}),[p]),P=n.React.useCallback((()=>{const e=o.asMutable({deep:!0}),t=function(e){let t="",s=0;function n(e){const t=/^Icon\s+([1-9]\d*)$/,s=e.match(t);return s?Number(s[1]):null}const r=[];(null==e?void 0:e.length)>0&&e.forEach((e=>{const t=null==e?void 0:e.name;t&&r.push(t)}));r.forEach((e=>{const t=n(e);"number"==typeof t&&t>0&&(s=Math.max(s,t))}));let i=s+1;for(;t=`Icon ${i}`,r.includes(t);)i++;return t}(o)||"",s={name:t,data:null};e.push(s);const r=(0,n.Immutable)(e);j(r)}),[o,j]),F=n.React.useCallback((()=>{a&&a(!s)}),[s,a]),R=n.React.useCallback((()=>{l&&l()}),[l]),A=n.React.useRef(o),k=n.React.useCallback((()=>{A.current=(0,n.Immutable)(o.asMutable({deep:!0}))}),[o]),_=n.React.useCallback(((e,t)=>{if(t&&(null==o?void 0:o.length)>0){if(o.find(((s,n)=>(null==s?void 0:s.name)===t&&n!==e)))return{valid:!1,msg:T}}return{valid:!0}}),[T,o]),L=n.React.useCallback((e=>({valid:!0})),[]),V=n.React.useCallback(((e,t)=>{const s=o.map(((s,n)=>{if(n===e){return s.set("name",t)}return s}));j(s)}),[o,j]),U=n.React.useCallback(((e,t)=>{var s;const n=(null===(s=null==t?void 0:t.target)||void 0===s?void 0:s.value)||"";V(e,n)}),[V]),H=n.React.useCallback(((e,t)=>{var s;let n=(null===(s=null==t?void 0:t.target)||void 0===s?void 0:s.value)||"";n=n.trim();if(!(n&&_(e,n).valid)){const t=A.current,s=t&&e<=t.length-1?t[e]:null,n=null==s?void 0:s.name;n&&V(e,n)}}),[V,_]),W=n.React.useCallback(((e,t)=>{const s=o.map(((s,n)=>{if(n===e){return s.set("data",t)}return s}));j(s)}),[o,j]),z=n.React.useCallback((e=>{const t=o.filter(((t,s)=>s!==e));j(t)}),[o,j]),q=!(!t&&!s);return(0,n.jsx)("div",{className:(0,n.classNames)("icons-selector h-100 p-3",e.className),css:B},x&&(0,n.jsx)(n.React.Fragment,null,(0,n.jsx)(u,null,(0,n.jsx)(r.Label,{className:"w-100 d-inline"},y),q&&(0,n.jsx)(r.Button,{className:"add-icon-btn mr-2",icon:!0,size:"sm",type:"tertiary",title:v,"aria-label":v,onClick:P},(0,n.jsx)(E,null)),!t&&(0,n.jsx)(r.Button,{className:"collapse-icon-btn",icon:!0,size:"sm",type:"tertiary",title:s?b:S,"aria-label":s?b:S,onClick:F},s?(0,n.jsx)(N,null):(0,n.jsx)(D,null)),t&&(0,n.jsx)(r.Button,{className:"close-btn",icon:!0,size:"sm",type:"tertiary",title:C,"aria-label":C,onClick:R},(0,n.jsx)(M,null))),q&&(0,n.jsx)("div",{className:"icons-body h-100"},(null==o?void 0:o.length)>0&&(0,n.jsx)(u,{className:"mt-2"},(0,n.jsx)(r.Label,{className:"d-inline",style:{width:"70px"}},I),(0,n.jsx)(r.Label,{className:"d-inline ml-3"},w)),null==o?void 0:o.map(((e,t)=>(0,n.jsx)(u,{key:t},(0,n.jsx)("div",{className:"text-input-and-icon-picker d-flex"},(0,n.jsx)(r.TextInput,{required:!0,size:"sm",style:{width:"70px"},value:(null==e?void 0:e.name)||"",onFocus:k,checkValidityOnChange:e=>_(t,e),checkValidityOnAccept:L,onChange:e=>{U(t,e)},onBlur:e=>{H(t,e)}}),(0,n.jsx)(g,{className:"ml-3",icon:null==e?void 0:e.data,configurableOption:"none",onChange:e=>{W(t,e)},"aria-label":w,setButtonUseColor:!1})),(0,n.jsx)(r.Button,{icon:!0,size:"sm",type:"tertiary",title:O,"aria-label":O,onClick:()=>{z(t)}},(0,n.jsx)($,null))))))))})));function V(e){var t;if(!e)return null;const s=function(){const e=(0,n.getAppStore)().getState(),t=window.jimuConfig.isBuilder?null==e?void 0:e.appStateInBuilder:e;return null==t?void 0:t.appConfig}();return null===(t=null==s?void 0:s.widgets)||void 0===t?void 0:t[e]}var U=function(e,t,s,n){return new(s||(s=Promise))((function(r,i){function o(e){try{l(n.next(e))}catch(e){i(e)}}function a(e){try{l(n.throw(e))}catch(e){i(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,a)}l((n=n.apply(e,t||[])).next())}))};let H=0;const W=n.css`
position: relative;
flex-direction: column;

.hidden {
  visibility: hidden;
}

.script-section {
  position: relative;
  display: flex;
  flex-direction: column;

  .text-area-container {
    position: relative;

    .jimu-input-area {
      textarea {
        height: 100%;
        resize: none;
      }
    }

    .copy-script-btn {
      position: absolute;
      right: 0;
      top: 0;
      cursor: pointer;
    }
  }
}

.arcade-script-stored-locally-tip {
  color: var(--sys-color-surface-overlay-hint, #DCDCDC);
  line-height: 20px;
}

.modal-arcgis-arcade-editor-container {
  position: relative;
  height: 600px;
  max-height: calc(100vh - 298px);

  .modal-arcgis-arcade-editor-overlay {
    position: absolute;
    left: 0;
    right: 0;
    top: 0;
    bottom: 0;
  }
}

.invalid-msg {
  white-space: nowrap;
  align-items: center;
}

arcgis-arcade-editor {
  --arcgis-coding-components-border: 1px solid var(--sys-color-divider-secondary, #585858);
  border-color: var(--sys-color-divider-secondary, #585858);

  calcite-action-bar.main-action-bar,
  arcgis-editor-variables.side-panel,
  arcgis-language-api-panel.side-panel,
  arcgis-arcade-suggestions.side-panel,
  calcite-action-bar.side-action-bar {
    border-color: var(--sys-color-divider-secondary, #585858);
  }
}

.arcade-content-builder-loading {
  background-color: var(--ref-palette-custom1-300);
}

.modal-icons-section {
  height: 40px;
  border: 1px solid var(--sys-color-divider-secondary, #585858);
  border-top: none;
}
`;function z(e){const t=e.invalidMessage,s=e.invalidKeys,i=e.unsupportedReturnTypeLabel;if(t){const o=(0,n.jsx)("div",{className:(0,n.classNames)("invalid-msg d-flex",e.className)},(0,n.jsx)(c,{size:16,color:"var(--sys-color-error-main)"}),(0,n.jsx)(r.Label,{className:"mb-0 ml-1"},t));let a="";return(null==s?void 0:s.length)>0&&(a=i+": "+s.join(", ")),a?(0,n.jsx)(r.Tooltip,{title:a,showArrow:!0,placement:"top"},o):o}return null}function q(e){let t=null;if(null==e||"number"==typeof e||"string"==typeof e||"boolean"==typeof e||e instanceof Date)t=e;else if(e&&"esri.arcade.Dictionary"===e.declaredClass){t={};const s=e.attributes;s&&Object.keys(s).forEach((e=>{t[e]=q(s[e])}))}else J(e)||K(e)?t=e.toString():Array.isArray(e)&&(t=e.map((e=>q(e))));return t}function J(e){return"esri.core.sql.dateonly"===(null==e?void 0:e.declaredRootClass)}function K(e){return"esri.core.sql.timeonly"===(null==e?void 0:e.declaredRootClass)}function G(e,t){if(e&&t){const{profile:s,profileVariableInstances:n,timeZone:r}=t;e.profile=s,e.testData={profileVariableInstances:n,timeZone:r||"system"}}}function X(e,t,s,r,i,o){const a={id:e,title:t,scriptContent:s,valueType:r,icons:i};(null==o?void 0:o.length)>0&&(a.useDataSources=o);return(0,n.Immutable)(a)}function Y(e){return`${n.arcadeContentUtils.doesWidgetHaveRepeatDataSource(e)?n.CONSTANTS.FEATURE_PROFILE_ARCADE_CONTENT_ID_PREFIX:n.CONSTANTS.DATA_SOURCES_PROFILE_ARCADE_CONTENT_ID_PREFIX}${(0,n.uuidv1)()}`}const Q=(0,i.withTheme)((0,n.injectIntl)((function(e){const t=e.onChange,s=e.capabilities,i=n.React.useMemo((()=>(null==s?void 0:s.length)>0?s:[n.ArcadeContentCapability.Value,n.ArcadeContentCapability.Style]),[s]),a=e.useTitle,l=e.widgetId,p=n.React.useRef(l);p.current=l;const c=e.config,d=null==c?void 0:c.id,u=n.React.useMemo((()=>{let e=c;if(e){if(!e.id){const t=Y(l);e=e.set("id",t)}}else{e=X(Y(l),"","",null,[],null)}return e}),[c,l]),h=u.id,g=n.React.useRef(h);g.current=h;const x=e.useDataSources,f=e.dynamicStyleTypes,v=e.modalOnly,b=e.insertMode,S=e.onModalClose,[E,C]=n.React.useState(!1),I=n.React.useRef(null);I.current=x,n.React.useEffect((()=>{const e=I.current;(null==e?void 0:e.length)>0&&function(e){return U(this,void 0,void 0,(function*(){if((null==e?void 0:e.length)>0){const t=n.DataSourceManager.getInstance(),s=e.map((e=>U(this,void 0,void 0,(function*(){try{yield t.createDataSourceByUseDataSource(e)}catch(t){console.error("dsManager.createDataSourceByUseDataSource() error",e,t)}}))));yield Promise.all(s)}}))}(e).then((()=>{C(!0)}))}),[]);const[w,N]=n.hooks.useArcgisArcadeEditor(),O=n.React.useMemo((()=>{if(!d&&h&&h.includes(n.CONSTANTS.DATA_SOURCES_PROFILE_ARCADE_CONTENT_ID_PREFIX)){return!n.arcadeContentUtils.canAddNewDataSourcesProfileArcadeContent(l)}return!1}),[h,d,l]),T=u.title||"",j=u.scriptContent||"",D=u.icons,P=i.includes(n.ArcadeContentCapability.Value),F=i.includes(n.ArcadeContentCapability.Style),R=e.useIcons,M=n.React.useMemo((()=>!!i.includes(n.ArcadeContentCapability.Style)&&!("boolean"==typeof R&&!R)),[i,R]),[A,k]=n.React.useState(!1),_=A||v,$=n.React.useRef(0),[B,Q]=n.React.useState(null),Z=n.React.useRef(null);Z.current=B;const ee=n.React.useRef(!1),[te,se]=n.React.useState(null),ne=!!te,re=n.React.useRef(null),[ie,oe]=n.React.useState(!1),ae=!E||!ie||!ne,[le,pe]=n.React.useState(!1),ce=n.React.useRef(null),[de,ue]=n.React.useState(!1),he=!E||!de||!ne,[me,ge]=n.React.useState(T),xe=n.React.useRef(T),[fe,ye]=n.React.useState(j),[ve,be]=n.React.useState(""),[Se,Ee]=n.React.useState([]),[Ce,Ie]=n.React.useState(D),we=n.React.useRef(null),[Ne,Oe]=n.React.useState(!1),[Te,je]=n.React.useState(!1),De=n.React.useRef(),[Pe,Fe]=n.React.useState(!1),Re=Pe?De.current:null,Me=n.hooks.useTranslation(r.defaultMessages),Ae=Me("editScriptInArcadeEditor"),ke=Me("arcadeEditor"),_e=Me("dataSourcesArcadeContentCountLimit"),$e=Me("scriptInUse"),Be=Me("addScriptFirst"),Le=Me("copyToClipboard"),Ve=Me("scriptCopied"),Ue=Me("arcadeScriptStoredLocally"),He=Me("reset"),We=Me("invalidArcadeScript"),ze=Me("unsupportedReturnType"),qe=Me(b?"insert":"apply"),Je=Me("close"),Ke=Me("arcadeScript"),Ge=Me("icons");n.React.useEffect((()=>{!function(){U(this,void 0,void 0,(function*(){let e="",t="";try{if(e=yield o.helpUtils.getWidgetHelpLink("advanced-formatting"),e||(e=""),e)try{t=yield n.urlUtils.createShortUrl(e),t||(t="")}catch(e){console.error("can not create short link for Arcade content help url",e),t=""}}catch(e){console.error("get Arcade content help doc url error",e)}se({url:t||e||""})}))}()}),[]),n.React.useEffect((()=>(function(e){return U(this,void 0,void 0,(function*(){var t;let s=null;try{if(e){const r=V(e),i=(null===(t=null==r?void 0:r.manifest)||void 0===t?void 0:t.name)||e;s=new n.indexedDBUtils.IndexedDBCache(e,i,"arcade"),yield s.init()}}catch(t){console.error("initialize arcade db error",e,t),s=null}return s&&!s.initialized()&&(s=null),s}))}(p.current).then((e=>{De.current=e,Fe(!0);const t=g.current;e&&t&&e.get(t).then((e=>{console.log("get Arcade script from indexedDB",t),"string"==typeof e&&e&&ye(e)})).catch((e=>{console.error("get Arcade script from indexedDB error",t,e)}))})),()=>{De.current&&De.current.close()})),[]);const Xe=n.React.useCallback((e=>{t&&(ee.current=!0,t(e))}),[t]),Ye=n.React.useCallback((()=>{const e=Z.current;if(!d&&!j&&!fe&&e&&te){const t=function(e,t,s,r,i){var o;let a="";t&&(a=`// Documentation: ${t}\n\n`);let l="";if((null==e?void 0:e.type)===n.ArcadeProfileType.DataSourcesProfile){const d="function getFilteredFeatureSet(ds) {\n  var result = ds.layer;\n  var queryParams = ds.queryParams;\n\n  if (!IsEmpty(queryParams.where)) {\n    result = Filter(result, queryParams.where);\n  }\n\n  if (!IsEmpty(queryParams.geometry)) {\n    result = Intersects(result, queryParams.geometry);\n  }\n\n  return result;\n}\n\n",u=e,h=null===(o=null==u?void 0:u.profileVariableInstances)||void 0===o?void 0:o.$dataSources,m=[];if(h){const g=n.DataSourceManager.getInstance();Object.keys(h).forEach(((e,t)=>{const s=t+1,n=g.getDataSource(e);if(n){const t=`\n// ${n.getLabel()||e}\n// The filteredFeatureSet${s} has already been filtered using spatial filters and attribute filters.\n// var filteredFeatureSet${s} = getFilteredFeatureSet($dataSources["${e}"]);\n// selectedFeatures${s} is the selection view of data source.\n// var selectedFeatures${s} = $dataSources["${e}"].selectedFeatures;\n\n`;m.push(t)}}))}l=d+m.join("")}let p="";if(r&&(null==i?void 0:i.length)>0){function x(e,t){let s=e;const n=`[placeholder_${t}_start]`,r=`[placeholder_${t}_end]`,i=e.indexOf(n),o=e.indexOf(r);if(i>=0&&o>=0){const t=o+r.length;s=e.slice(0,i)+e.slice(t)}return s}p="\nreturn {\n  [placeholder_value_start]value: '',[placeholder_value_end]\n  [placeholder_background_start]background: {\n    // color: 'green',\n    // fillType: 'fill', // 'fit', 'fill', 'center', 'tile', 'stretch'\n    // image: ''\n  },[placeholder_background_end]\n  [placeholder_text_start]text: {\n    // size: 14,\n    // color: 'rgb(0, 0, 255)',\n    // bold: true,\n    // italic: false,\n    // underline: false,\n    // strike: false\n  },[placeholder_text_end]\n  [placeholder_border_start]border: {\n    // border: {\n    //   type: 'dashed', // 'solid', 'dashed', 'dotted', 'double'\n    //   color: 'red',\n    //   width: 1\n    // }\n  },[placeholder_border_end]\n  [placeholder_borderRadius_start]borderRadius: {\n    // unit: 'px', // 'px', 'rem', 'em', 'vw', '%'\n    // number: [5, 5, 5, 5]\n  },[placeholder_borderRadius_end]\n  [placeholder_icon_start]icon: {\n    // name: '',\n    // position: 'LEFT', // 'LEFT', 'RIGHT'\n    // size: 30,\n    // color: 'green'\n  }[placeholder_icon_end]\n};\n  ",s||(p=x(p,"value")),i.includes(n.DynamicStyleType.Background)||(p=x(p,"background")),i.includes(n.DynamicStyleType.Text)||(p=x(p,"text")),i.includes(n.DynamicStyleType.Border)||(p=x(p,"border")),i.includes(n.DynamicStyleType.BorderRadius)||(p=x(p,"borderRadius")),i.includes(n.DynamicStyleType.Icon)||(p=x(p,"icon"));const f=/\[placeholder_\w+_(?:start|end)\]/g;p=p.replace(f,"");const y=/^\s*$(?:\r\n?|\n)/gm;p=p.replace(y,""),p="\n"+p}else p=s?'return "";':"return {};";const c=a+l+p;return c}(e,te.url,P,F,f);t&&t!==j&&ye(t)}}),[d,f,te,fe,j,F,P]),Qe=n.React.useRef();Qe.current=Ye;const Ze=n.React.useCallback((e=>{Z.current=e,Q(e),G(re.current,e),G(ce.current,e),!B&&e&&Qe.current()}),[B]);n.React.useEffect((()=>{te&&Qe.current()}),[te]);const et=n.React.useRef(!1);et.current=a&&!T;const tt=n.React.useRef(!1),st=n.React.useRef("");st.current=Me("arcade"),n.React.useEffect((()=>{if(et.current){H++,tt.current=!0;const e=`${st.current} ${H}`;ge(e)}return()=>{tt.current&&!ee.current&&H--}}),[]);const nt=n.React.useCallback((()=>{O||(be(""),Ee([]),je(!1),k(!0))}),[O]),rt=n.React.useCallback((()=>{!function(){U(this,void 0,void 0,(function*(){try{yield navigator.clipboard.writeText(j),pe(!0)}catch(e){console.error("copy Arcade script error",e)}finally{setTimeout((()=>{pe(!1)}),2e3)}}))}()}),[j]),it=n.React.useCallback((e=>{e&&e.componentOnReady().then((()=>{oe(!0)})).catch((e=>{console.error("ArcgisArcadeEditor componentOnReady error",e)})),re.current=e,G(e,B)}),[B]),ot=Te||a&&!me||!fe||me===T&&fe===j&&Ce===D,at=fe!==j&&!(!d&&b),lt=n.React.useCallback((e=>{var t;const s=(null===(t=null==e?void 0:e.target)||void 0===t?void 0:t.value)||"";ge(s)}),[]),pt=n.React.useCallback((e=>{var t;const s=(null===(t=null==e?void 0:e.target)||void 0===t?void 0:t.value)||"";xe.current=s}),[]),ct=n.React.useCallback((e=>{var t;!((null===(t=null==e?void 0:e.target)||void 0===t?void 0:t.value)||"")&&xe.current&&ge(xe.current)}),[]),dt=n.React.useCallback((()=>{ye(j)}),[j]),ut=n.React.useCallback((e=>{e&&e.componentOnReady().then((()=>{ue(!0)})).catch((e=>{console.error("ArcgisArcadeEditor componentOnReady error",e)})),ce.current=e,G(e,B)}),[B]),ht=n.React.useCallback((e=>{const t=e.detail||"";ye(t)}),[]),mt=n.React.useCallback((()=>{Oe(!Ne)}),[Ne]),gt=n.React.useCallback((()=>{Oe(!1)}),[]),xt=n.React.useCallback((()=>{Oe(!1)}),[]),ft=n.React.useCallback((e=>{Ie(e)}),[]),yt=n.React.useCallback((()=>{const e=ce.current;if(!e)return;$.current++,je(!0);const t=$.current;(function(e,t,s,r,i){return U(this,void 0,void 0,(function*(){let o=null;const a={valueType:null,errorMsg:i,invalidKeys:[]},l={valueType:null,errorMsg:r,invalidKeys:[]},p=(null==t?void 0:t.script)||"",c=null==t?void 0:t.profile;let d=[];try{const r=t.getTestResult(),u=function(e,t,s){return U(this,void 0,void 0,(function*(){var r,i;let o=[];try{if(1===(null===(r=s.variables)||void 0===r?void 0:r.length)){const r=s.variables[0];if("$feature"===(null==r?void 0:r.name)&&1===(null==e?void 0:e.length)&&e[0]){const r=yield(0,n.loadArcGISJSAPIModule)("esri/arcade"),a=yield r.createArcadeExecutor(t,s);if((null===(i=null==a?void 0:a.fieldsUsed)||void 0===i?void 0:i.length)>0){const t=a.fieldsUsed.slice().map((e=>e.toLocaleLowerCase())),s=e[0].asMutable({deep:!0}),r=n.DataSourceManager.getInstance().getDataSource(s.dataSourceId);if(r){const e=r.getSchema(),n=null==e?void 0:e.fields;if(n){const e=Object.keys(n).filter((e=>t.includes(e.toLocaleLowerCase())));e.length>0&&(delete s.useFieldsInPopupInfo,delete s.useFieldsInSymbol,s.fields=e,o=[s])}}}}}}catch(e){console.error("getArcadeUseDataSources() error",e),o=[]}return o}))}(e,p,c),[h,m]=yield Promise.all([r,u]);if(d=m,h){const e=h.type;if("error"===e)return o=l,o;if("number"===e)o={valueType:n.JimuFieldType.Number,errorMsg:"",invalidKeys:[]};else if("text"===e)o={valueType:n.JimuFieldType.String,errorMsg:"",invalidKeys:[]};else if("date"===e)o={valueType:n.JimuFieldType.Date,errorMsg:"",invalidKeys:[]};else if("dateOnly"===e)o={valueType:n.JimuFieldType.DateOnly,errorMsg:"",invalidKeys:[]};else if("time"===e)o={valueType:n.JimuFieldType.TimeOnly,errorMsg:"",invalidKeys:[]};else if("dictionary"===e){const e=h.value;if(e&&"esri.arcade.Dictionary"===e.declaredClass){const t=e.attributes;if(t){const r=t.value;J(r)?o={valueType:n.JimuFieldType.DateOnly,errorMsg:"",invalidKeys:[]}:K(r)?o={valueType:n.JimuFieldType.TimeOnly,errorMsg:"",invalidKeys:[]}:"number"==typeof r?o={valueType:n.JimuFieldType.Number,errorMsg:"",invalidKeys:[]}:"string"==typeof r?o={valueType:n.JimuFieldType.String,errorMsg:"",invalidKeys:[]}:r instanceof Date?o={valueType:n.JimuFieldType.Date,errorMsg:"",invalidKeys:[]}:null==r&&(o=s?{valueType:null,errorMsg:i,invalidKeys:["value"]}:{valueType:null,errorMsg:"",invalidKeys:[]}),o||(o={valueType:null,errorMsg:i,invalidKeys:["value"]}),o.invalidKeys||(o.invalidKeys=[]);const a=q(e);if(a){delete a.value;const e=n.arcadeContentUtils.validateArcadeScriptResult(a);e.valid||(o.errorMsg=i),o.invalidKeys.push(...e.invalidKeys)}}}}o||(o=a)}}catch(e){console.error("ArcadeEditor can not get test result",e),o=l}return o&&s&&!o.valueType&&!o.errorMsg&&(o=l),o||(o=l),o.invalidKeys||(o.invalidKeys=[]),(null==d?void 0:d.length)>0&&(o.arcadeUseDataSources=d),o}))})(x,e,P,We,ze).then((e=>U(this,void 0,void 0,(function*(){if($.current!==t)return;je(!1);const{valueType:s,errorMsg:n,invalidKeys:r,arcadeUseDataSources:i}=e;if(n)be(n||We),Ee(r);else{const e=X(h,me,fe,s,Ce,i);if(Xe(e),be(""),Ee([]),k(!1),Re&&h)try{yield Re.delete(h),console.log("delete Arcade script from indexedDB",h)}catch(e){console.error("delete Arcade script from indexedDB error",h,e)}S&&S()}}))))}),[h,Re,We,fe,Ce,me,S,ze,Xe,x,P]),vt=n.React.useCallback((()=>{if($.current++,k(!1),je(!1),!b){let e=u;me&&me!==T&&(e=e.set("title",me)),Ce!==D&&(e=e.set("icons",Ce));const t=!d&&e.id&&at;(t||d&&e!==u)&&Xe(e);Re&&h&&(t||d)&&Re.put(h,fe).then((()=>{console.log("save Arcade script into indexedDB",h)})).catch((e=>{console.error("save Arcade script into indexedDB error",h,e)}))}S&&S()}),[h,d,u,D,Re,b,fe,Ce,me,S,at,T,Xe]),bt=v?"d-none":"d-flex";return(0,n.jsx)("div",{className:(0,n.classNames)("arcade-style-builder p-4 h-100",bt,e.className),css:W},!v&&(0,n.jsx)(n.React.Fragment,null,(0,n.jsx)("div",{className:"mb-4","aria-label":Ae},Ae),(0,n.jsx)(r.Button,{className:"mb-4",color:"primary","aria-label":ke,disabled:O,onClick:nt},ke),O&&(0,n.jsx)(r.Alert,{className:"w-100 mt-2",form:"basic",text:_e,type:"warning",withIcon:!0}),!O&&(0,n.jsx)(n.React.Fragment,null,(0,n.jsx)("div",{className:"mb-4","aria-label":$e},$e),(0,n.jsx)("div",{className:"script-section h-100"},(0,n.jsx)("div",{className:"text-area-container h-100"},(0,n.jsx)(r.TextArea,{className:"h-100",disabled:!0,value:j,placeholder:Be}),j&&(0,n.jsx)(r.Tooltip,{title:Ve,open:le,disableFocusListener:!0,disableHoverListener:!0,disableTouchListener:!0},(0,n.jsx)(r.Button,{className:"copy-script-btn",size:"sm",icon:!0,type:"tertiary",target:"_blank",disableHoverEffect:!0,disableRipple:!0,title:Le,"aria-label":Le,onClick:rt},(0,n.jsx)(m,null)))))),w&&N&&(0,n.jsx)(N,{className:"hidden-arcgis-arcade-editor d-none",ref:it,editorOptions:{theme:"vs-dark"},script:fe}),ae&&(0,n.jsx)(r.Loading,{className:"arcade-content-builder-loading",type:r.LoadingType.Secondary})),(0,n.jsx)(n.ArcadeProfileContextProvider,{usedForArcadeEditor:!0,widgetId:l,useDataSources:x,onProfileContextChange:Ze}),_&&!O&&(0,n.jsx)(r.Modal,{className:(0,n.classNames)("arcade-editor-modal",e.className),css:W,style:{maxWidth:1120,flexDirection:"row"},centered:!0,contentClassName:"border-0 h-100",isOpen:!0,keyboard:!0},(0,n.jsx)(r.ModalHeader,{className:"d-flex justify-content-between align-items-center",toggle:vt},Ke),(0,n.jsx)(r.ModalBody,{className:"w-auto pt-2"},a&&(0,n.jsx)("div",{className:"mb-2"},(0,n.jsx)(r.Label,null,Me("name")),(0,n.jsx)(r.TextInput,{disabled:Te,value:me,onChange:lt,onFocus:pt,onBlur:ct})),(0,n.jsx)("div",{className:(0,n.classNames)(["arcade-script-stored-locally-tip-container d-flex align-items-center",{hidden:!at}])},(0,n.jsx)(y,{color:"var(--sys-color-info-main)"}),(0,n.jsx)("div",{className:"arcade-script-stored-locally-tip ml-2","aria-label":Ue},Ue),(0,n.jsx)(r.Button,{className:"ml-2",size:"sm",onClick:dt},He)),w&&N&&(0,n.jsx)("div",{className:"modal-arcgis-arcade-editor-container mt-2"},(0,n.jsx)(N,{className:"modal-arcgis-arcade-editor h-100",ref:ut,editorOptions:{theme:"vs-dark"},script:fe,onArcgisScriptChange:ht}),Te&&(0,n.jsx)("div",{className:"modal-arcgis-arcade-editor-overlay"})),M&&(0,n.jsx)("div",{className:"modal-icons-section d-flex align-items-center w-100"},(0,n.jsx)(r.Button,{className:"ml-2",type:"default",size:"sm","aria-label":Ge,ref:we,onClick:mt},Ge),Ne&&(0,n.jsx)(r.Popper,{open:Ne,placement:"top-start",reference:we,toggle:gt,offsetOptions:[0,8]},(0,n.jsx)("div",{className:"modal-icons-selector-container",style:{minWidth:"230px",height:"246px"}},(0,n.jsx)(L,{inModal:!0,expand:!1,icons:Ce,onClose:xt,onIconsChange:ft})))),he&&(0,n.jsx)(r.Loading,{className:"arcade-content-builder-loading",type:r.LoadingType.Secondary})),(0,n.jsx)(r.ModalFooter,{className:"d-flex flex-column pb-30"},(0,n.jsx)("div",{className:"w-100 d-flex justify-content-between"},(0,n.jsx)(z,{className:"modal-invalid-msg mr-2",invalidMessage:ve,invalidKeys:Se,unsupportedReturnTypeLabel:ze}),(0,n.jsx)(r.Button,{type:"primary",className:"ml-auto mr-2",style:{minWidth:"64px",minHeight:"32px"},"aria-label":qe,disabled:ot,onClick:yt},Te&&(0,n.jsx)(r.Loading,{type:r.LoadingType.Donut,height:20,width:20}),!Te&&qe),!b&&(0,n.jsx)(r.Button,{type:"secondary",style:{minWidth:"64px",minHeight:"32px"},"aria-label":Je,onClick:vt},Je)))))})));class Z extends n.React.PureComponent{constructor(e){super(e),this.overflowYStyle={overflow:"hidden"},this.__unmount=!1,this.state={SidePopper:null}}componentDidMount(){this.__unmount=!1,n.moduleLoader.loadModule("jimu-ui/advanced/setting-components").then((e=>{!this.__unmount&&this.setState({SidePopper:e.SidePopper})}))}componentWillUnmount(){this.__unmount=!0}render(){const e=this.state.SidePopper,t=this.props.intl.formatMessage({id:"arcade",defaultMessage:r.defaultMessages.arcade});return(0,n.jsx)("div",{className:"arcade-content-builder-popup w-100 h-100"},e&&(0,n.jsx)(e,{isOpen:this.props.isOpen&&!n.urlUtils.getAppIdPageIdFromUrl().pageId,position:"right",toggle:this.props.onClose,trigger:this.props.trigger,backToFocusNode:this.props.backToFocusNode,title:t},(0,n.jsx)("div",{className:"h-100 bg-default border-color-gray-400 component-arcade-content-builder-popup"},(0,n.jsx)("div",{className:"w-100 h-100 arcade-popup"},(0,n.jsx)("div",{style:this.overflowYStyle,className:"h-100"},(0,n.jsx)(Q,Object.assign({},this.props)))))))}}const ee=(0,i.withTheme)((0,n.injectIntl)(Z))},44529:e=>{"use strict";e.exports=r},45508:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 16 16"><path fill="#000" d="M8 5.5a1 1 0 1 0 0-2 1 1 0 0 0 0 2M6.5 7.5A.5.5 0 0 1 7 7h1.5v4.5h1a.5.5 0 0 1 0 1h-3a.5.5 0 0 1 0-1h1V8H7a.5.5 0 0 1-.5-.5"></path><path fill="#000" fill-rule="evenodd" d="M8 16A8 8 0 1 1 8 0a8 8 0 0 1 0 16m0-1A7 7 0 1 0 8 1a7 7 0 0 0 0 14" clip-rule="evenodd"></path></svg>'},54207:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 16 16"><path fill="#000" d="M0 0h16v16H0z" opacity=".01"></path><path fill="#000" d="M2 7.527q.65 0 .984-.457t.333-1.293V3.971q0-.552.15-.93.15-.379.4-.6a1.4 1.4 0 0 1 .567-.33Q4.767 2 5.118 2h1.05v.851h-.8q-.3 0-.5.126a.76.76 0 0 0-.284.3 1.3 1.3 0 0 0-.133.426q-.034.236-.034.457v1.806q0 .569-.183.962a1.9 1.9 0 0 1-.417.615 1.7 1.7 0 0 1-.483.33q-.25.095-.4.111v.032q.15.015.4.126.25.094.483.331.25.22.417.615.183.378.183.946v1.806q0 .221.034.457.033.237.133.426a.76.76 0 0 0 .284.3q.2.126.5.126h.8V14h-1.05q-.351 0-.684-.11a1.4 1.4 0 0 1-.567-.331 1.54 1.54 0 0 1-.4-.6q-.15-.378-.15-.93v-1.806q0-.835-.333-1.293Q2.65 8.473 2 8.473zM14 8.473q-.65 0-.984.457t-.333 1.293v1.806q0 .552-.15.93-.15.379-.4.6a1.4 1.4 0 0 1-.584.33q-.316.111-.667.111h-1.05v-.851h.8q.3 0 .484-.126a.73.73 0 0 0 .3-.3q.1-.189.133-.426a3 3 0 0 0 .034-.457v-1.806q0-.568.166-.946.183-.395.417-.615.25-.237.5-.331.25-.111.4-.126v-.032q-.15-.015-.4-.11a2 2 0 0 1-.5-.331 2.3 2.3 0 0 1-.417-.615q-.166-.394-.167-.962V4.16q0-.221-.033-.457a1.3 1.3 0 0 0-.133-.426.73.73 0 0 0-.3-.3.84.84 0 0 0-.484-.126h-.8V2h1.05q.35 0 .667.11.334.095.584.331.25.221.4.6.15.378.15.93v1.806q0 .836.333 1.293.334.457.984.457z"></path></svg>'},62838:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 16 16"><path fill="#000" d="m8.745 8 6.1 6.1a.527.527 0 1 1-.745.746L8 8.746l-6.1 6.1a.527.527 0 1 1-.746-.746l6.1-6.1-6.1-6.1a.527.527 0 0 1 .746-.746l6.1 6.1 6.1-6.1a.527.527 0 0 1 .746.746z"></path></svg>'},68972:e=>{"use strict";e.exports=n},72259:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 16 16"><path fill="#000" fill-rule="evenodd" d="M14 8A6 6 0 1 1 2 8a6 6 0 0 1 12 0m1 0A7 7 0 1 1 1 8a7 7 0 0 1 14 0M4 8a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7A.5.5 0 0 1 4 8" clip-rule="evenodd"></path></svg>'},79244:e=>{"use strict";e.exports=s},93303:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 16 16"><path fill="#000" fill-rule="evenodd" d="M9.438.994c.213 0 .397.146.44.35q.227 1.084.316 1.852.562.242 1.048.599l1.728-.676a.455.455 0 0 1 .556.188l1.42 2.394a.43.43 0 0 1-.091.547 22 22 0 0 1-1.49 1.194q.03.27.03.552 0 .32-.038.63l1.465 1.12a.43.43 0 0 1 .111.563l-1.42 2.394a.454.454 0 0 1-.53.197 23 23 0 0 1-1.807-.66q-.49.35-1.055.586l-.263 1.794a.446.446 0 0 1-.445.376H6.574a.446.446 0 0 1-.44-.35 21 21 0 0 1-.317-1.853 5.3 5.3 0 0 1-1.047-.598l-1.728.675a.455.455 0 0 1-.556-.187l-1.42-2.395a.43.43 0 0 1 .091-.546q.85-.735 1.49-1.194a5.167 5.167 0 0 1 .008-1.183L1.19 6.243a.43.43 0 0 1-.112-.562l1.42-2.395a.455.455 0 0 1 .531-.196q1.078.35 1.807.66c.324-.233.679-.43 1.056-.587l.262-1.794A.446.446 0 0 1 6.6.994zm-.365 1H6.985l-.28 1.866-.467.19q-.353.144-.672.34l-.207.136-.42.293-.476-.197q-.492-.205-1.169-.433l-.221-.074-1.045 1.719L3.59 6.999l-.06.479a4 4 0 0 0-.021.816l.014.144.058.492-.419.294q-.433.304-.979.746l-.177.145 1.043 1.72 1.845-.703.406.29q.307.219.645.384l.228.103.474.199.059.49q.06.507.19 1.177l.043.219h2.088l.282-1.867.466-.19q.354-.144.672-.34l.207-.136.419-.293.476.198q.495.204 1.17.433l.22.072 1.044-1.718-1.56-1.165.06-.479a4 4 0 0 0 .02-.815l-.013-.144-.06-.492.42-.295a18 18 0 0 0 .98-.746l.176-.146-1.043-1.72-1.844.705-.406-.29a4.5 4.5 0 0 0-.646-.385l-.228-.103-.474-.199-.058-.49q-.049-.405-.14-.916zm-1.067 3a3 3 0 1 1 0 6 3 3 0 0 1 0-6m0 1a2 2 0 1 0 0 4 2 2 0 0 0 0-4" clip-rule="evenodd"></path></svg>'},94064:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 16 16"><path fill="#000" fill-rule="evenodd" d="M13.854 11.347a.486.486 0 0 1-.708 0L8 5.76l-5.146 5.587a.485.485 0 0 1-.708 0 .54.54 0 0 1 0-.738l5.5-5.956a.485.485 0 0 1 .708 0l5.5 5.956a.54.54 0 0 1 0 .738" clip-rule="evenodd"></path></svg>'},94747:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 16 16"><path fill="#000" fill-rule="evenodd" d="M2.547 1.788A.5.5 0 0 1 3 1.5h9.167c.358 0 .699.147.947.403.249.255.386.599.386.954v1.714a.5.5 0 0 1-1 0V2.857a.37.37 0 0 0-.103-.257.32.32 0 0 0-.23-.1h-8.1l4.317 5.18a.5.5 0 0 1 0 .64L4.068 13.5h8.099a.32.32 0 0 0 .23-.1.37.37 0 0 0 .103-.257v-1.714a.5.5 0 1 1 1 0v1.714c0 .355-.137.699-.386.954-.248.257-.59.403-.947.403H3a.5.5 0 0 1-.384-.82L7.349 8 2.616 2.32a.5.5 0 0 1-.069-.532" clip-rule="evenodd"></path></svg>'},98657:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 16 16"><path fill="#000" fill-rule="evenodd" d="M11 2v10H3V4.414L5.414 2zM2 4.414a1 1 0 0 1 .293-.707l2.414-2.414A1 1 0 0 1 5.414 1H11a1 1 0 0 1 1 1v10a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1zM13.048 3v10.56c0 .265-.214.48-.477.48H4V15h8.571c.79 0 1.429-.645 1.429-1.44V3z" clip-rule="evenodd"></path></svg>'}},t={};function p(s){var n=t[s];if(void 0!==n)return n.exports;var r=t[s]={exports:{}};return e[s].call(r.exports,r,r.exports,p),r.exports}p.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return p.d(t,{a:t}),t},p.d=(e,t)=>{for(var s in t)p.o(t,s)&&!p.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},p.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),p.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var c={};return(()=>{"use strict";p.r(c),p.d(c,{AttributeTab:()=>Ie,ExpressionBuilder:()=>Ae,ExpressionBuilderPopup:()=>_e,ExpressionBuilderType:()=>i,ExpressionEditor:()=>Ce,ExpressionInput:()=>Xe,ExpressionInputType:()=>d,StatisticsTab:()=>Re,_ExpressionBuilder:()=>Me,_ExpressionBuilderPopup:()=>ke});var e={};p.r(e),p.d(e,{ExpressionBuilder:()=>s,ExpressionEditor:()=>n,ExpressionInput:()=>r});var t=p(79244);function s(e){const s=e.theme;return t.css`
    .component-expression-builder{
      .w-33{
        width: 33% !important;
      }
      .w-85{
        width: 85%;
      }
      .fixed-at-bottom{
        width: 100%;
        height: ${t.polished.rem(64)};
        border-top: 1px solid ${s.ref.palette.neutral[700]};
        position: fixed;
        bottom: 0;
        left: 0;
        background-color: ${s.ref.palette.neutral[400]};
      }
      .expression-builder-tab{
        padding-top: 1rem;
        padding-bottom: 1rem;
        overflow: hidden;
        width: 100%;
        height: 100%;
      }
      .common-tab{
        .option-label{
          font-size: ${t.polished.rem(13)};
          font-weight: 500;
          color: ${s.ref.palette.neutral[900]};
        }
        .data-option{
          padding-left: 1rem;
          padding-right: 1rem;
        }
      }
      .field-selector-container{
        height: 100%;
      }
      .expression-editor-container{
        height: calc(100% - 90px);
      }
      .expression-editor-helper{
        height: calc(100% - 130px);
        .tab-content{
          margin: 0 -1rem;
        }
      }
      .exp-editor-helper-tab{
        height: calc(100% - 20px);
      }
      .field-selector-container, .expression-editor-container{
        width: 100%;
      }
      .expression-insert-btn{
        width: ${t.polished.rem(180)};
      }
      .stat-inter-btn{
        max-width: 100%;
      }
    }

  `}function n(e){const s=e.theme;return t.css`
    .component-expression-editor{
      .mt-18{
        margin-top: 18px;
      }
      .jimu-nav.nav.nav-pills.nav-fill{
        border-top: 0;
        border-left: 0;
        border-right: 0;
      }
      .expression-editor-input{
        -webkit-user-select: text !important;
        user-select: text !important;
        font-size: 13px;
        font-weight: 400;
        overflow-x: hidden;
        overflow-y: auto;
        min-height: ${t.polished.rem(48)};
        max-height: ${t.polished.rem(100)};
        user-select: none;
        border: 0;
        outline: none;
        background-color: ${s.ref.palette.neutral[300]};
        padding: 1px;
        .expression-editor-input-content-editable:focus{
          border-color: ${s.sys.color.primary.dark};
          outline: none;
        }
        .expression-editor-input-content-editable{
          border: 1px solid ${s.ref.palette.neutral[300]};
          min-height: ${t.polished.rem(48)};
          max-height: ${t.polished.rem(100)};
          border-radius: 2px;
          outline: none;
        }
        p{
          min-height: 100%;
        }
        .break-all{
          word-break: break-all;
        }
        span.error-exp{
          color: ${s.sys.color.error.light};
        }
        .field-exp{
          color: ${s.sys.color.warning.light};
        }
        .function-exp{
          color: ${s.sys.color.primary.light};
        }
        .number-exp{
          color: ${s.sys.color.info.main};
        }
        .string-exp{
          color: ${s.sys.color.success.light};
        }
        .operator-exp{
          color: ${s.ref.palette.neutral[1100]};
        }
        .order-exp{
          color: ${s.ref.palette.success[500]};
        }
        .unknown-exp{
          color: ${s.sys.color.error.light};
        }
        .ds-disabled-exp{
          color: ${s.sys.color.error.light};
        }
      }

      .error-border{
        border: 1px solid #FF5066;
        outline: none;
        .expression-editor-input-content-editable{
          outline: none;
          border: 0;
        }
      }

      .expression-editor-function-item{
        border: 1px solid transparent;
        cursor: pointer;
        background-color: ${s.ref.palette.neutral[500]};
        user-select: none;
      }
      .expression-editor-function-item-selected{
        border: 1px solid ${s.sys.color.primary.main};
      }
      .expression-editor-function-item:hover{
        background-color: ${s.ref.palette.neutral[500]};
      }
      .expression-editor-function-item:active.expression-editor-function-item:hover{
        background-color: ${s.ref.palette.white};
      }

      .exp-editor-helper{
        user-select: none;
      }
      .with-error-message .exp-editor-helper .component-field-selector .field-list{
        height: calc(100% - 185px);
      }
      .exp-editor-helper-tab{
        margin-left: -16px;
        margin-right: -16px;
      }

      .error-message{
        height: 20px;
        line-height: 20px;
      }

      .exp-popper{
        background-color: ${s.ref.palette.neutral[300]};
        border: 1px solid ${s.ref.palette.neutral[700]};
        font-size: 13px;
        width: ${t.polished.rem(200)};
        z-index: 1;
        padding: 0 !important;
        box-shadow: 0 0 8px 0 ${t.polished.rgba(s.ref.palette.white,.5)};
        .exp-popper-item{
          padding-left: 8px;
          padding-right: 8px;
        }
        .jimu-popper--arrow::after {
          border-bottom-color: ${s.ref.palette.neutral[300]} !important;
        }
      }
      .exp-popper-selected-item, .exp-popper-item:hover{
        background-color: ${s.sys.color.secondary.main};
        cursor: pointer;
      }

    }

  `}function r(e){const s=e.theme;return t.css`
    .component-expression-input{
      font-size: ${s.ref.typeface.fontSize};
      .input-wrapper{
        height: ${t.polished.rem(26)};
        padding-top: 0;
        padding-bottom: 0;
      }
      .disabled-input-cover{
        width: 100%;
        height: 100%;
        position: relative;
        top: -100%;
        &.ds-disabled{
          background-color: transparent;
        }
      }
      .ds-disabled{
        background-color: ${s.ref.palette.neutral[300]};
        cursor: pointer;
        border: 0;
        >span.error-wrapper{
          color: ${s.ref.palette.neutral[1200]};
          background-color: ${t.polished.rgba(s.sys.color.error.main,.5)};
          vertical-align: sub;
          margin-left: 5px;
          margin-right: 5px;
        }
      }
      .ds-placeholder{
        >span{
          color: ${s.ref.palette.neutral[900]};
          background-color: transparent;
        }
      }
      .expression-builder-trigger{
        cursor: pointer;
        width: 26px;
        height: 26px;
        padding: 0;
        .dropdown-button-content{
          display: flex;
          align-items: center;
          justify-content: center;
        }
        .expression-builder-trigger-dropdown{
          padding: 0;
          .trigger-dropdown-toggle{
            background: ${s.ref.palette.neutral[600]};
            border-radius: 2px 0 0 2px;
            border-color: ${s.ref.palette.neutral[600]};
          }
        }
      }
      .expression-input{
        height: ${t.polished.rem(26)};
        .jimu-input, .ds-placeholder{
          border-radius: 0 2px 2px 0;
        }
      }
    }

  `}var i,o,a=p(1888),l=p(14321);!function(e){e.Attribute="ATTRIBUTE",e.Statistics="STATISTICS",e.Expression="EXPRESSION"}(i||(i={})),function(e){e.Arcade="ARCADE",e.Static="STATIC"}(o||(o={}));const d=Object.assign(Object.assign({},i),o);function u(e,s){const n=t.DataSourceManager.getInstance();if(e&&e.dataSourceId&&s){if(e.dataSourceId.split("-").reverse()[0]===t.CONSTANTS.SELECTION_DATA_VIEW_ID){const n=t.DataSourceManager.getInstance().getDataSource(e.dataSourceId),r=n&&n.getMainDataSource(),i=r&&r.id;return s.some((e=>(null==e?void 0:e.mainDataSourceId)===i))}return!!(s.some((t=>(null==t?void 0:t.dataSourceId)===e.dataSourceId))&&n&&n.getDataSource(e.dataSourceId))}return!0}function h(e,t){if(!e)return"";switch(e){case d.Attribute:return t.formatMessage({id:"attribute",defaultMessage:l.defaultMessages.attribute});case d.Statistics:return t.formatMessage({id:"statistics",defaultMessage:l.defaultMessages.statistics});case d.Expression:return t.formatMessage({id:"expression",defaultMessage:l.defaultMessages.expression});case d.Arcade:return t.formatMessage({id:"arcade",defaultMessage:l.defaultMessages.arcade});case d.Static:return t.formatMessage({id:"static",defaultMessage:l.defaultMessages.static});default:return""}}function m(e){return e===t.ExpressionFunctions.PercentileContinuous||e===t.ExpressionFunctions.PercentileDiscrete}function g(e,s){return m(e)?null==s?void 0:s.map((e=>{var s,n,r;return(null===(r=null===(n=null===(s=t.DataSourceManager.getInstance().getDataSource(e.dataSourceId))||void 0===s?void 0:s.getCapabilities)||void 0===n?void 0:n.call(s))||void 0===r?void 0:r.getQueryCapabilities().supportsPercentileStatistics)||(e=e.set("dataSourceId",t.DataSourceManager.getInstance().getDataViewDataSourceId(e.mainDataSourceId,t.CONSTANTS.SELECTION_DATA_VIEW_ID)).set("dataViewId",t.CONSTANTS.SELECTION_DATA_VIEW_ID)),e})):s}var x=p(44529),f=p(17123),y=p.n(f);const v="part",b="expression";var S,E;!function(e){e.Part="PART",e.Char="CHAR"}(S||(S={})),function(e){e.Field="FIELD",e.DataSource="DATA_SOURCE",e.Function="FUNCTION",e.Order="ORDER"}(E||(E={}));class C extends t.React.PureComponent{render(){return t.React.createElement("span",{className:this.props.className,contentEditable:!!this.props.isEditable,suppressContentEditableWarning:!0,id:this.props.id,style:this.props.style,title:this.props.title||null,tabIndex:this.props.tabIndex||null},this.props.exp)}}class I extends t.React.PureComponent{constructor(){super(...arguments),this.getDsLabel=()=>{const e=t.DataSourceManager.getInstance(),s=e&&e.getDataSource(this.props.dataSourceId);return s?s.getLabel():null}}render(){return t.React.createElement(C,Object.assign({},this.props,{className:(0,t.classNames)("field-exp",{[this.props.className]:!!this.props.className,"error-exp":this.props.isError,"ds-disabled-exp":this.props.isDsDisabled}),style:this.props.style,title:this.getDsLabel(),tabIndex:0}))}}class w extends t.React.PureComponent{render(){return t.React.createElement(C,Object.assign({},this.props,{className:"string-exp",tabIndex:0}))}}class N extends t.React.PureComponent{constructor(){super(...arguments),this.getFunctionTooltip=e=>{if(!e)return null;const s=this.props.exp;switch(s){case t.ExpressionFunctions.Average:return"Average ( fieldName ) returns  { Number }";case t.ExpressionFunctions.Count:return"Count ( fieldName ) returns  { Number }";case t.ExpressionFunctions.Sum:return"Sum ( fieldName ) returns  { Number }";case t.ExpressionFunctions.Max:return"Max ( fieldName ) returns  { Number }";case t.ExpressionFunctions.Min:return"Min ( fieldName ) returns  { Number }";case t.ExpressionFunctions.StandardDeviation:return"Standard deviation ( fieldName ) returns  { Number }";case t.ExpressionFunctions.PercentileContinuous:return"Percentile continuous ( fieldName, value, order ) returns  { Number }";case t.ExpressionFunctions.PercentileDiscrete:return"Percentile discrete ( fieldName, value, order ) returns  { Number }";default:throw new Error(`Unhandled case: ${s}`)}}}render(){return t.React.createElement(C,{exp:this.props.exp,isEditable:!!this.props.isEditable,id:this.props.id,title:this.getFunctionTooltip(this.props.exp),className:(0,t.classNames)("function-exp",{[this.props.className]:!!this.props.className,"ds-disabled-exp":this.props.isDsDisabled})})}}class O extends t.React.PureComponent{render(){return t.React.createElement(C,Object.assign({},this.props,{className:(0,t.classNames)("number-exp",{[this.props.className]:!!this.props.className}),style:this.props.style,tabIndex:0}))}}class T extends t.React.PureComponent{render(){return t.React.createElement(C,Object.assign({},this.props,{className:"unknown-exp"}))}}class j extends t.React.PureComponent{render(){return t.React.createElement(C,Object.assign({},this.props,{className:"operator-exp"}))}}class D extends t.React.PureComponent{constructor(e){super(e),this.itemHeight=25,this.popoverItemStyle={lineHeight:`${this.itemHeight}px !important`},this.getTarget=(e,t)=>e&&t?t.querySelector(`#${e}`):null,this.state={targetNode:this.getTarget(this.props.targetNodeId,this.props.containerNode)}}componentDidUpdate(e){if(this.props.selectedItemIndex!==e.selectedItemIndex&&this.props.selectedItemIndex&&this.root){let t;if(parseInt(this.props.selectedItemIndex)>parseInt(e.selectedItemIndex))if(parseInt(this.props.selectedItemIndex)===this.props.items.length-1)t=this.root.scrollHeight-this.root.offsetHeight;else{const e=Math.floor((this.root.scrollTop+this.root.offsetHeight)/this.itemHeight)-1;t=parseInt(this.props.selectedItemIndex)>=e?this.root.scrollTop+this.itemHeight:this.root.scrollTop}else if(0===parseInt(this.props.selectedItemIndex))t=0;else{const e=Math.floor(this.root.scrollTop/this.itemHeight);t=parseInt(this.props.selectedItemIndex)<=e?this.root.scrollTop-this.itemHeight:this.root.scrollTop}this.root.scrollTo(null,t)}this.props.expSelection===e.expSelection&&this.props.targetNodeId===e.targetNodeId&&this.props.containerNode===e.containerNode||this.setState({targetNode:this.getTarget(this.props.targetNodeId,this.props.containerNode)})}render(){return this.state.targetNode&&this.props.items&&0!==this.props.items.length?(0,t.jsx)(l.Popper,{reference:this.state.targetNode,open:this.props.isOpen,autoFocus:!1,placement:"bottom",className:"exp-popper",offsetOptions:5,arrowOptions:!0,disablePortal:!0},(0,t.jsx)("div",{style:{width:"200px",maxHeight:"200px",overflow:"auto"},ref:e=>{this.root=e}},this.props.items.map(((e,s)=>(0,t.jsx)("div",{key:s,onClick:()=>{this.props.onClick&&this.props.onClick(e,this.props.targetNodeId)},className:(0,t.classNames)("text-break exp-popper-item",{"exp-popper-selected-item":`${s}`===this.props.selectedItemIndex}),title:e.content,css:(0,t.css)(this.popoverItemStyle)},e.content))))):null}}var P,F=p(41496);function R(e,t){return e?t?t.querySelector(`#${e}`):document&&document.querySelector(`#${e}`):null}function M(e,t){if(!t||function(e){if(!e)return!1;const t=e.split("-");return!(!t.length||2!==t.length||t[0]!==b||!/^\d+$/.test(t[1]))}(t.id))return null;for(;t&&!_(e,t.id);)t=t.parentElement;return t?t.id:null}function A(e,t){return L(t)?`${e}-${v}-${t}`:null}function k(e,t){if(!t)return null;const s=t.split("-"),n=_(e,t)?s.length-1:-1;return n>-1?parseInt(s[n]):null}function _(e,t){if(!t||!e)return!1;const s=function(e,t){return t&&e?t.split(`${e}-`)[1]:null}(e,t);return!(!s||s.split("-").length!==v.split("-").length+1||t.indexOf(v)!==e.length+1||!/\d$/.test(t))}function $(e){return!e||(e.type?e.type===t.ExpressionPartType.String||e.type===t.ExpressionPartType.Field||e.type===t.ExpressionPartType.Operator:(console.warn("Part has no type: ",e),!1))}function B(e){return!!e&&(z(e)||V(e)||U(e))}function L(e){return!isNaN(e)&&"[object Number]"===Object.prototype.toString.call(e)}function V(e){return!(!e||'"'!==e)}function U(e){return!(!e||"{"!==e)}function H(e){return/^\{(.*?)\}$/.test(e)}function W(e){return!!e&&/^\"(.*?)\"$/.test(e)}function z(e){return!!e&&/^[\+\-\*\/\,\(\)\s+]$/.test(e)}function q(e,s,n,r){const i=function(e,t,s){if(!s||!t||0===t.length)return{};const n={};return t.forEach((e=>{n[e.mainDataSourceId]||(n[e.mainDataSourceId]=[]),n[e.mainDataSourceId].some((t=>t.dataSourceId===e.dataSourceId))||(n[e.mainDataSourceId]=n[e.mainDataSourceId].concat(e))})),n}(0,s,n);Object.keys(i).forEach((o=>{var a;i[o]=null===(a=i[o])||void 0===a?void 0:a.concat(function(e,s,n,r,i){if(!s||0===s.length||!r)return[];let o=[];if(!s.some((e=>e.dataViewId===t.CONSTANTS.SELECTION_DATA_VIEW_ID))){const e=s[0].set("dataSourceId",t.DataSourceManager.getInstance().getDataViewDataSourceId(s[0].mainDataSourceId,t.CONSTANTS.SELECTION_DATA_VIEW_ID)).set("dataViewId",t.CONSTANTS.SELECTION_DATA_VIEW_ID);o=o.concat(e)}if(i&&function(e,s,n,r){var i,o,a,l,p;const c=(null===(i=null===window||void 0===window?void 0:window.jimuConfig)||void 0===i?void 0:i.isBuilder)?null===(a=null===(o=(0,t.getAppStore)().getState())||void 0===o?void 0:o.appStateInBuilder)||void 0===a?void 0:a.appConfig:null===(l=(0,t.getAppStore)().getState())||void 0===l?void 0:l.appConfig;if(!(c&&e&&s&&0!==s.length&&n&&r))return!1;const d=F.searchUtils.getParentWidgetIdOfContent(c,e,t.LayoutItemType.Widget,r),u=c.widgets[d],h=u&&(null===(p=u.manifest.properties)||void 0===p?void 0:p.canProvideRepeatDataSource);let m=!1;for(let e=0;e<s.length;e++){const t=J(s[e],n);if(m=(null==u?void 0:u.useDataSources)&&u.useDataSources.some((e=>(null==t?void 0:t.dataSourceId)===e.dataSourceId)),m)break}return h&&m}(e,s,n,r)){const e=s[0].set("dataSourceId",t.DataSourceManager.getInstance().getDataViewDataSourceId(s[0].mainDataSourceId,t.CONSTANTS.REPEAT_CONTEXT_DATA_VIEW_ID)).set("dataViewId",t.CONSTANTS.REPEAT_CONTEXT_DATA_VIEW_ID);o=o.concat(e)}return o}(e,i[o],s,n,r))}));let o=(0,t.Immutable)([]);return Object.values(i).forEach((e=>{o=o.concat(e)})),o}function J(e,s){if(!e)return null;if(e.dataViewId===t.CONSTANTS.REPEAT_CONTEXT_DATA_VIEW_ID){const n=s.find((t=>t.mainDataSourceId===e.mainDataSourceId));return n&&(0,t.Immutable)(n)}return e}function K(e,t){if(!e||!e.collapsed||!t)return;let s;const n=e;return!!(n.compareBoundaryPoints&&document&&document.createRange)&&(s=document.createRange(),s.selectNodeContents(t),s.collapse(!0),n.compareBoundaryPoints(n.START_TO_END,s)<1)}function G(e,t){if(!e||!e.collapsed||!t)return;let s;const n=e;return!!(n.compareBoundaryPoints&&document&&document.createRange)&&(s=document.createRange(),s.selectNodeContents(t),s.collapse(!1),n.compareBoundaryPoints(n.START_TO_END,s)>-1)}function X(e,t,s,n=!0){const r=R(e,s);if(r&&t>=0&&window.getSelection){const e=Y(r,{count:t});e&&(n&&e.collapse(!1),window.getSelection().removeAllRanges(),window.getSelection().addRange(e))}}function Y(e,t,s){if(!document||!document.createRange)return null;if(s||((s=document.createRange()).selectNodeContents(e),s.setStart(e,0)),0===t.count)s.setEnd(e,t.count);else if(e&&t.count>0)if(e.nodeType===Node.TEXT_NODE)e.textContent.length<t.count?t.count-=e.textContent.length:(s.setEnd(e,t.count),t.count=0);else for(let n=0;n<e.childNodes.length&&(s=Y(e.childNodes[n],t,s),0!==t.count);n++);return s}function Q(){let e=null;if(window.getSelection&&window.getSelection().getRangeAt){const t=window.getSelection();t.rangeCount>0&&(e=t.getRangeAt(0))}return e}function Z(e,t){const s=Q();if(!s)return null;let n=null;const r=s.startContainer.nodeType===Node.TEXT_NODE?s.startContainer.parentElement:s.startContainer,i=r===(s.endContainer.nodeType===Node.TEXT_NODE?s.endContainer.parentElement:s.endContainer)&&r&&_(e,r.id),o=i?r:null,a=i?r.id:null;return o&&a&&(n={partId:a,startOffset:s.startOffset,endOffset:s.endOffset,contentLength:o.textContent.length||0}),n}function ee(e){const t=document&&document.querySelector(`#${e}`),s=Q();let n,r;if(t&&s)for(n=t.lastElementChild;n;){if(G(s,n)&&_(e,n.id)){r=n;break}n=n.previousElementSibling}return r}function te(e){const t=document&&document.querySelector(`#${e}`),s=Q();let n,r;if(t&&s)for(n=t.firstElementChild;n;){if(K(s,n)&&_(e,n.id)){r=n;break}n=n.nextElementSibling}return r}function se(e,t,s,n,r){const i=R(t,document&&document.querySelector(`#${e}`));let o=null,a=null;return i?(!s&&i.nextElementSibling&&_(e,i.nextElementSibling.id)?o=i.nextElementSibling.id:s&&i.previousElementSibling&&_(e,i.previousElementSibling.id)&&(o=i.previousElementSibling.id),a=o?{type:S.Char,partId:o,startOffset:s?R(o,document&&document.querySelector(`#${e}`)).textContent.length:0}:{partId:A(e,s?0:r&&r.length>0?r.length-1:0),toStart:s,type:S.Part},a):null}function ne(e){const t=Q();let s;if(t.collapsed){const t=ee(e);s=t&&t.id&&_(e,t.id)&&k(e,t.id)}else t.startContainer.nodeType===Node.TEXT_NODE&&(/^\ufeff$/.test(t.startContainer.textContent)||/^\ufeff$/.test(t.startContainer.parentElement.previousSibling.textContent))?s=0:t.startContainer.id===e?s=t.startOffset-1:_(e,t.startContainer.id)?s=k(e,t.startContainer.id)+t.startOffset+1:console.warn("Can not get start part of selection");return L(s)?s:null}function re(e,t=[]){const s=Q();let n;if(s.collapsed){const t=ee(e);n=t&&t.id&&_(e,t.id)&&k(e,t.id)}else s.endContainer.nodeType===Node.TEXT_NODE&&(/^\ufeff$/.test(s.endContainer.textContent)||/^\ufeff$/.test(s.startContainer.parentElement.previousSibling.textContent))?n=t.length-1>-1?t.length-1:0:s.endContainer.id===e?n=s.endOffset-2:_(e,s.endContainer.id)?n=k(e,s.endContainer.id)-s.endOffset-1:console.warn("Can not get end part of selection");return L(n)?n:null}function ie(e,s,n,r,i,o){let a=null;if(!n)return a;const l=Object.keys(n).find((e=>n[e]&&n[e].part&&(n[e].part.type===t.ExpressionPartType.String&&'""'===n[e].part.exp||n[e].part.type===t.ExpressionPartType.Field&&"{}"===n[e].part.exp)));if(l&&n[l]&&n[l].part)a={partId:A(e,parseInt(l)),type:S.Char,startOffset:1};else{const l=function(e){return e?Object.keys(e).filter((t=>e[t]&&e[t].part&&!e[t].isReplacing)).map((e=>parseInt(e))):[]}(n),p=function(e){return e?Object.keys(e).filter((t=>e[t]&&!e[t].part&&e[t].isReplacing)).map((e=>parseInt(e))):[]}(n),c=l.length>0;if(p.length>0){const i=Math.min.apply(null,p)-1,o=r[i];if(s)if(o)a=p.length===Object.keys(n).length?{partId:A(e,i),type:S.Char,startOffset:o.type===t.ExpressionPartType.String||o.type===t.ExpressionPartType.Field?o.exp.length-1:o.exp.length}:oe(e,r,n);else{a={partId:A(e,i>-1?i:0),type:S.Part,toStart:!0}}else if(p.length===Object.keys(n).length){const t=!(i>-1);a={partId:A(e,i>-1?i:0),type:S.Part,toStart:t}}else a=oe(e,r,n)}else if(c)if(l.length===Object.keys(n).length){const t=Math.max.apply(null,l),s=A(e,t),r=n[t]&&n[t].part;a={partId:s,type:S.Char,startOffset:r&&r.exp&&r.exp.length}}else a=oe(e,r,n);else{const t=ae(e,n),l=L(t)?t:parseInt(Object.keys(n)[0]),p=L(l)&&A(e,l);if(s){const t=i&&i.partId,s=p===t,c=i.endOffset-(L(o)?o:0),d=r[k(e,t)],u=d&&d.exp?d.exp.length:-1;a={partId:p,type:S.Char,startOffset:s&&c>=0&&c<=u?c:n[l]&&L(n[l].startOffset)?n[l].startOffset:0}}else a={partId:p,type:S.Char,startOffset:n[l].startOffset}}}return a}function oe(e,t,s){const n=ae(e,s),r=L(n),i=r?n:t.length-1,o=r?s[n].startOffset:0;return{partId:A(e,i),type:S.Char,startOffset:o}}function ae(e,t){const s=Object.keys(t).find((e=>t[e].part&&L(t[e].startOffset)));return parseInt(s)}function le(e){let t=function(e){const t=e.split(/([\"])/g).filter((e=>!!e));let s="",n=!1,r=!1;const i=[];return t.forEach(((e,o)=>{'"'===e?(s+=e,r=n,n=!0,n&&r&&(i.push(s),s="",n=!1,r=!1)):n?s+=e:i.push(e),o===t.length-1&&n&&!r&&i.push(s)})),i}(e.replace(/\ufeff/g,""));return t=function(e){let t=e.map((e=>W(e)?e:e.split(/({[^\{\}]*})/g).filter((e=>!!e))));return t=Array.prototype.concat.apply([],t),t}(t),t=function(e){let t=e.map((e=>W(e)||H(e)?e:e.split(/(\s*[\+\-\*\/\(\)\s]\s*)/g).filter((e=>!!e))));return t=Array.prototype.concat.apply([],t),t}(t),t}function pe(e,t,s,n,r){const i={};return!e||!L(t)||t<0||e.forEach(((e,o)=>{const a=L(s)&&s>-1&&o===s,l=L(r)&&r>-1&&o===r?n:null;i[t+o]={part:e,isReplacing:a,startOffset:l}})),i}function ce(e,t=[]){if(!e)return t;const s=(t=t||[]).slice();let n=0;const r=[];return Object.keys(e).sort(((e,t)=>parseInt(e)-parseInt(t))).forEach((t=>{n+=e[t].isReplacing?1:0,e[t].part&&r.push(e[t].part)})),s.splice(Math.min.apply(null,Object.keys(e)),n,...r),s}function de(e){return!!e&&(e===t.ExpressionPartType.Field||e===t.ExpressionPartType.Function||e===t.ExpressionPartType.Order)}function ue(e,s){if(!e||!s)return null;const n=t.DataSourceManager.getInstance().getDataSource(e),r=n&&n.getSchema&&n.getSchema(),i=r&&r.fields;return i&&Object.keys(i).sort(((e,t)=>e.localeCompare(t))).find((e=>(i[e].alias||i[e].name)===s))||null}function he(e,s,n,r){return H(e)?{type:t.ExpressionPartType.Field,exp:e,dataSourceId:s,jimuFieldName:r||ue(s,e.replace(/^\{/,"").replace(/\}$/,"")),isFromRepeatedDataSourceContext:!!n}:function(e){return!!e&&Object.keys(t.ExpressionFunctions).some((s=>t.ExpressionFunctions[s]===e))}(e)?{type:t.ExpressionPartType.Function,exp:e}:function(e){return!!e&&(/^\d*\.?\d+(\d|\s)*$/.test(e)||/^\d+\.?\d*(\d|\s)*$/.test(e))}(e)?{type:t.ExpressionPartType.Number,exp:e}:z(e)?{type:t.ExpressionPartType.Operator,exp:e}:W(e)?{type:t.ExpressionPartType.String,exp:e}:function(e){return!!e&&["ASC","DESC"].includes(e)}(e)?{type:t.ExpressionPartType.Order,exp:e}:{type:t.ExpressionPartType.Unknown,exp:e}}function me(e,t,s,n){if(!(t=t||[])||!L(s)||!L(n))return null;const r=t[s-1],i=t[n+1],o={};if(r&&i&&!$(r)&&!$(i)){const e=le(r.exp+i.exp).map(((e,t)=>he(e)));for(let t=s-1;t<=n+1;t++)o[t]={part:e[t-(s-1)]||null,isReplacing:!0,startOffset:e[t-(s-1)]?r.exp.length:null}}else for(let e=s;e<=n;e++)o[e]={part:null,isReplacing:!0,startOffset:null};return o}function ge(e,t,s,n,r){t=t||[];const i=k(e,s),o=t&&t[i];if(!o||!o.exp||!L(n)||!L(r)||n<0||r<0)return null;let a={};const l=o.exp.slice(n,r+1),p=0===n,c=r===o.exp.length-1;let d;var u;d=(p||c)&&V(l)?o.exp.replace(/^\"/,"").replace(/\"$/,""):p&&U(l)||c&&((u=l)&&"}"===u)?o.exp.replace(/^\{/,"").replace(/\}$/,""):`${o.exp.slice(0,n)}${o.exp.slice(r+1)}`;const h=he(d,o.dataSourceId,o.isFromRepeatedDataSourceContext,o.jimuFieldName);if(h.exp.length>0)if($(h))a[i]={part:h,isReplacing:!0,startOffset:n+1-(r-n+1)};else{const e=t[i-1],s=t[i+1],n=le(d.replace(/\"/g,'""').replace(/\{/g,"{}")).map((e=>he(e))),r=$(e),o=$(s);let l,u,h,m;e&&s&&!r&&!o?(u=e.exp+d+s.exp,l=2):e&&!r?(u=e.exp+d,l=1):s&&!o?(u=d+s.exp,l=1):(u=d,l=0),e&&!r?(h=i-1,m=p?e.exp.length:c?n[n.length-1].exp.length:0):(h=i,m=p?0:c?n[n.length-1].exp.length:0);const g=le(u.replace(/\"/g,'""').replace(/\{/g,"{}")).map((e=>he(e))),x=p?h:c?h+g.length-1:null;for(let e=h;e<=h+g.length+l-1;e++)a[e]={part:g[e-h]||null,isReplacing:e-h<=l,startOffset:e===x?m:null}}else a=me(0,t,i,i);return a}function xe(e,s,n,r,i,o){if(!s||!n)return[];let a=[];const l=k(e,s),p=n[l];if(p){if(p.type===t.ExpressionPartType.Field){if(p.dataSourceId){const e=t.DataSourceManager.getInstance().getDataSource(p.dataSourceId),s=e&&e.getSchema&&e.getSchema().fields;s&&Object.keys(s).filter((e=>{const t=s[e].alias||s[e].name;return t&&0===t.toLowerCase().indexOf(p.exp.replace(/[\{\}]/g,"").toLowerCase())})).filter((e=>{if(n[l-1]&&n[l-1].type===t.ExpressionPartType.Operator&&"("===n[l-1].exp&&n[l-2]&&n[l-2].type===t.ExpressionPartType.Function){const r=n[l-2].exp;if(r===t.ExpressionFunctions.Count)return!0;const i=r===t.ExpressionFunctions.Min||r===t.ExpressionFunctions.Max;return s[e].type===t.JimuFieldType.Number||i&&(s[e].type===t.JimuFieldType.Date||s[e].type===t.JimuFieldType.DateOnly||s[e].type===t.JimuFieldType.TimeOnly)}return!0})).sort(((e,t)=>s[e].name.localeCompare(s[t].name))).forEach((e=>{a.push({id:e,content:s[e].alias||s[e].name,type:E.Field})}))}else if(r&&r.length>0){const e=l>1&&"("===n[l-1].exp&&n[l-2].type===t.ExpressionPartType.Function,s=!e,p=e?g(n[l-2].exp,r):r;a=function(e,s){const n=[];return e&&e.asMutable().forEach((e=>{const r=t.DataSourceManager.getInstance().getDataSource(J(e,s).dataSourceId);if(r){let s;s=e.dataViewId&&e.dataViewId!==t.CONSTANTS.OUTPUT_DATA_VIEW_ID?e.dataViewId===t.CONSTANTS.SELECTION_DATA_VIEW_ID?`${r.getMainDataSource().getLabel()} / ${t.i18n.getIntl().formatMessage({id:"selectionDataView"})}`:e.dataViewId===t.CONSTANTS.REPEAT_CONTEXT_DATA_VIEW_ID?`${r.getMainDataSource().getLabel()} / ${t.i18n.getIntl().formatMessage({id:"populatedDataView"})}`:`${r.getMainDataSource().getLabel()} / ${r.getLabel()}`:r.getLabel(),n.push({id:e.dataSourceId,content:s,type:E.DataSource})}})),n}(q(i,p,o,s),p)}}else if(p.type===t.ExpressionPartType.Unknown){let e,s=l-1;for(;s>-1&&(e=n[s],!e||/^\s*$/.test(e.exp));)s--;(null==e?void 0:e.type)===t.ExpressionPartType.Operator&&","===e.exp?["ASC","DESC"].filter((e=>0===e.toLowerCase().indexOf(p.exp.toLowerCase()))).forEach((e=>{a.push({id:e,content:e,type:E.Order})})):(c=t.ExpressionFunctions,Object.keys(c).sort(((e,t)=>e.localeCompare(t)))).filter((e=>0===t.ExpressionFunctions[e].toLowerCase().indexOf(p.exp.toLowerCase()))).forEach((e=>{a.push({id:e,content:t.ExpressionFunctions[e],type:E.Function})}))}var c;return a}}function fe(e,s,n){if(!document||!document.querySelector(`#${e}`))return null;let r=ee(e);for(;r&&n[k(e,r.id)]&&n[k(e,r.id)].type===t.ExpressionPartType.Operator;)r=r.previousElementSibling;return!s&&r?r.id:function(e){const t=Q();if(t&&t.collapsed&&t.startContainer)return M(e,t.startContainer);return null}(e)}!function(e){e.Fields="FIELDS",e.Functions="FUNCTIONS"}(P||(P={}));class ye extends t.React.PureComponent{constructor(e){var s,n;super(e),this.__unmount=!1,this.ExpEditorHelperTabs={[P.Fields]:this.props.intl.formatMessage({id:"fields",defaultMessage:l.defaultMessages.fields}),[P.Functions]:this.props.intl.formatMessage({id:"functions",defaultMessage:l.defaultMessages.functions})},this.getSelectedFields=()=>{var e,s;const n=this.getEditingPartIndex(),r=null===(s=null===(e=this.props.expression)||void 0===e?void 0:e.parts)||void 0===s?void 0:s[n];if((null==r?void 0:r.type)===t.ExpressionPartType.Field){const e=r.jimuFieldName;if(e){const s=r.dataSourceId;return s?(0,t.Immutable)({[s]:[e]}):null}}return null},this.getSelectedFunction=(e=!0)=>{var s,n;const r=e?this.getEditingPartIndex():k(this.props.externalId,this.getSelectionPartId())-1,i=null===(n=null===(s=this.props.expression)||void 0===s?void 0:s.parts)||void 0===n?void 0:n[r];return(null==i?void 0:i.type)===t.ExpressionPartType.Function?i.exp:null},this.onFunctionSelect=e=>{if(!e)return;const s={type:t.ExpressionPartType.Function,exp:e};let n;n=this.getIsReplacing()?[s]:[s,{type:t.ExpressionPartType.Operator,exp:"("},{type:t.ExpressionPartType.Operator,exp:")"}],this.changeExpression(n,this.props.expression)},this.onFieldSelect=(e,s,n)=>{const r=e&&e[0];if(!r||!s)return;const i={type:t.ExpressionPartType.Field,exp:`{${r.alias||r.name}}`,dataSourceId:s.id,jimuFieldName:r.jimuName,isFromRepeatedDataSourceContext:n};this.changeExpression([i],this.props.expression)},this.onActiveTabChange=e=>{this.setState({active:e})},this.getSelectionPartId=()=>{var e,t;let s;if(this.props.inEditablePart){const e=Z(this.props.externalId,this.props.container);s=e&&e.partId}else{const e=ee(this.props.externalId);s=e&&e.id}return function(e){if(!e)return!1;const t=Q();if(!t)return!1;const s=t.commonAncestorContainer;return e.contains(s)}(document&&(null===(e=document.querySelector(`#${this.props.externalId}`))||void 0===e?void 0:e.parentElement))||(s=null),s=s||(null===(t=this.props.expSelection)||void 0===t?void 0:t.partId),s||(s=A(this.props.externalId,0)),s},this.changeExpression=(e,t)=>{if(!e)return;const s=this.getIsReplacing(),n=this.getNewPartIndex(e,t,s),r=A(this.props.externalId,n);let i=t&&t.parts&&t.parts.slice()||[];if(0===i.length)i=e;else{const t=s?1:0;i.splice(n,t,...e)}this.props.onSelect({name:t&&t.name||this.props.externalId,parts:i},r,s)},this.getNewPartIndex=(e,s,n)=>{var r,i,o;if(!e)return null;let a;if(0===(s&&s.parts||[]).length)a=0;else if(n)a=this.getEditingPartIndex();else{const s=this.getSelectionPartId();let n=k(this.props.externalId,s);s===(null===(r=this.props.expSelection)||void 0===r?void 0:r.partId)&&((null===(i=this.props.expSelection)||void 0===i?void 0:i.type)===S.Char&&0===this.props.expSelection.startOffset||(null===(o=this.props.expSelection)||void 0===o?void 0:o.type)===S.Part&&this.props.expSelection.toStart)&&n--,a=function(e){if(!e)return!1;const s=e[0]&&e[0].type===t.ExpressionPartType.Function,n=e[1]&&e[1].type===t.ExpressionPartType.Operator&&"("===e[1].exp,r=e[e.length-1]&&e[e.length-1].type===t.ExpressionPartType.Operator&&")"===e[e.length-1].exp;return s&&n&&r}(e)?n+1:n+e.length}return a},this.getEditingPartIndex=()=>{if(!this.props.inEditablePart)return null;const e=this.getSelectionPartId();return k(this.props.externalId,e)},this.getIsReplacing=()=>{var e,s;const n=this.getEditingPartIndex(),r=null===(s=null===(e=this.props.expression)||void 0===e?void 0:e.parts)||void 0===s?void 0:s[n];return(null==r?void 0:r.type)===t.ExpressionPartType.Field||(null==r?void 0:r.type)===t.ExpressionPartType.Function};const r=this.getEditingPartIndex(),i=null===(n=null===(s=this.props.expression)||void 0===s?void 0:s.parts)||void 0===n?void 0:n[r];this.state={active:(null==i?void 0:i.type)===t.ExpressionPartType.Function?P.Functions:P.Fields,FieldSelector:null}}componentDidMount(){this.__unmount=!1,t.moduleLoader.loadModule("jimu-ui/advanced/data-source-selector").then((e=>{!this.__unmount&&this.setState({FieldSelector:e.FieldSelector})}))}componentDidUpdate(e){var s,n;if(e.expSelection!==this.props.expSelection&&this.getIsReplacing()){const e=this.getEditingPartIndex(),r=null===(n=null===(s=this.props.expression)||void 0===s?void 0:s.parts)||void 0===n?void 0:n[e];this.setState({active:(null==r?void 0:r.type)===t.ExpressionPartType.Function?P.Functions:P.Fields})}}componentWillUnmount(){this.__unmount=!0}render(){if(!this.props.container)return null;const e=this.state.FieldSelector;return t.React.createElement("div",{className:"exp-editor-helper h-100"},t.React.createElement(l.Tabs,{fill:!0,type:"pills",className:"h-100",value:this.state.active,onChange:this.onActiveTabChange},t.React.createElement(l.Tab,{id:P.Fields,key:P.Fields,title:this.ExpEditorHelperTabs[P.Fields]},e&&t.React.createElement(e,{widgetId:this.props.widgetId,useDataSources:g(this.getSelectedFunction(!1),this.props.useDataSources),onChange:this.onFieldSelect,useSelectionDataView:!0,usePopulatedDataView:!0,selectedFields:this.getSelectedFields()})),t.React.createElement(l.Tab,{id:P.Functions,key:P.Functions,title:this.ExpEditorHelperTabs[P.Functions]},t.React.createElement(ve,{onSelect:this.onFunctionSelect,selectedFunction:this.getSelectedFunction()}))))}}const ve=({onSelect:e,selectedFunction:s})=>t.React.createElement("div",{className:"mt-18 px-4"},Object.keys(t.ExpressionFunctions).map(((n,r)=>t.React.createElement("div",{onClick:()=>{e(t.ExpressionFunctions[n])},key:r,className:(0,t.classNames)("mt-3 p-1 expression-editor-function-item",{"expression-editor-function-item-selected":s===t.ExpressionFunctions[n]}),tabIndex:0},t.ExpressionFunctions[n]))));class be extends t.React.PureComponent{render(){return t.React.createElement(C,Object.assign({},this.props,{className:(0,t.classNames)("order-exp",{[this.props.className]:!!this.props.className}),style:this.props.style,tabIndex:0}))}}class Se extends t.React.PureComponent{constructor(e){super(e),this.expressionString="",this.ltrStyle={direction:"ltr"},this.getFocusOnce=!1,this.resizeHelperContainer=()=>{var e,t,s,n;const r=(null===(t=null===(e=this.contentEditableContainer)||void 0===e?void 0:e.current)||void 0===t?void 0:t.offsetHeight)||0,i=(null===(n=null===(s=this.errorMsgContainer)||void 0===s?void 0:s.current)||void 0===n?void 0:n.offsetHeight)||0;this.helperContainer.current.style.height=`calc(100% - 30px - ${r}px - ${i}px)`},this.setSelectionToEnd=()=>{this.setState({isPopoverOpen:!1,expSelection:{partId:this.props.expression&&this.props.expression.parts&&A(this.id,this.props.expression.parts.length-1)||A(this.id,0),type:S.Part,toStart:!1}})},this.getWhetherLoseFocus=()=>{const e=window.getSelection&&window.getSelection();return!(e&&this.contentEditableContainer&&this.contentEditableContainer.current.contains(e.focusNode)&&this.contentEditableContainer.current!==e.focusNode)},this.getExpressionString=e=>{const t=e||this.contentEditableContainer?this.contentEditableContainer.current:document,s=t&&t.querySelector(`#${this.id}`);return s?s.textContent.replace(/\ufeff/g,""):""},this.getComponent=(e,s)=>{var n;const r=A(this.id,s),i=this.getWhetherInEditablePart();switch(e.type){case t.ExpressionPartType.Field:return(0,t.jsx)(I,{exp:e.exp,id:r,key:s,isDsDisabled:!u(e,this.props.useDataSources),isEditable:i&&this.state.expSelection.partId===r,dataSourceId:e.dataSourceId,isError:!t.expressionUtils.getWhetherFieldInDs(e.dataSourceId,e.jimuFieldName,e.exp.replace(/^\{/,"").replace(/\}$/,""))});case t.ExpressionPartType.String:return(0,t.jsx)(w,{exp:e.exp,id:r,key:s,isEditable:i&&this.state.expSelection.partId===r});case t.ExpressionPartType.Operator:return(0,t.jsx)(j,{exp:e.exp,id:r,key:s,isEditable:i&&this.state.expSelection.partId===r});case t.ExpressionPartType.Function:return(0,t.jsx)(N,{exp:e.exp,id:r,key:s,isDsDisabled:!u(e,this.props.useDataSources),isEditable:i&&this.state.expSelection.partId===r,externalId:this.id,dataSourceIds:null===(n=this.props.useDataSources)||void 0===n?void 0:n.map((e=>e.dataSourceId))});case t.ExpressionPartType.Number:return(0,t.jsx)(O,{exp:e.exp,id:r,key:s,isEditable:i&&this.state.expSelection.partId===r});case t.ExpressionPartType.Order:return(0,t.jsx)(be,{exp:e.exp,id:r,key:s,isEditable:i&&this.state.expSelection.partId===r});case t.ExpressionPartType.Unknown:return(0,t.jsx)(T,{exp:e.exp,id:r,key:s,isEditable:i&&this.state.expSelection.partId===r});default:return null}},this.getWhetherInEditablePart=()=>!(!this.state.expSelection||this.state.expSelection.type!==S.Char),this.getSingleExpFromPopoverItem=e=>e.type===E.Field?`{${e.content}}`:e.content,this.renderPartsToHtml=e=>x.renderToStaticMarkup((0,t.jsx)("p",{id:this.id,className:"w-100 m-0 p-1",spellCheck:!1,style:{textAlign:"left"}},"\ufeff",e&&e.map(((e,t)=>this.getComponent(e,t))),"\ufeff")),this.getNewExpression=e=>({parts:e,name:this.props.expression&&this.props.expression.name||this.id}),this.onChange=e=>{const t=e.currentTarget.querySelector(`#${this.id}`);if(!t||!e.isTrusted)return;const s=this.getExpressionString(t),n=function(e,t){const s=e.split("");return t.split("").find(((e,t)=>e!==s[t]))}(this.expressionString,s);if(!n)return;const r=this.getWhetherInEditablePart(),i=this.props.expression&&this.props.expression.parts,o=r?Q():null,a=te(this.id),l=function(e,t,s,n,r,i){let o={};if(!s)return o;t=(t=t||[])||[];const a=i?k(e,i.id):t.length,l=V(s)?'""':U(s)?"{}":s,p=le(l).map((e=>he(e))),c=p[0]&&1===p[0].exp.length?B(p[0].exp):$(p[0]),d=p[p.length-1]&&1===p[p.length-1].exp.length?B(p[p.length-1].exp):$(p[p.length-1]);if(n){const e=a-1>0?a-1:0,n=t[e],i=$(n),u=r&&r.startOffset,h=r&&r.startContainer,m=!(!u||u!==s.length),g=!(!u||!h||u!==h.textContent.length);if(i)if(m){const s=e-1,n=t[s];if($(n)||c)o=pe(p,e);else{const e=le(n.exp+l).map((e=>he(e)));o=pe(e,s,0,e[e.length-1].exp.length,e.length-1)}}else if(g){const e=t[a];if($(e)||d)o=pe(p,a);else{const t=le(l+e.exp).map((e=>he(e))),s=t[t.length-1].exp.length-e.exp.length>-1?t[t.length-1].exp.length-e.exp.length:t[t.length-1].exp.length;o=pe(t,a,t.length-1,s,t.length-1)}}else{const s=t[e],n=h&&h.textContent,i=s&&n&&he(n,s.dataSourceId,s.isFromRepeatedDataSourceContext,s.jimuFieldName);o[e]={part:i,isReplacing:!0,startOffset:r&&r.startOffset}}else if(m)if(d)o=pe(p,e);else{const t=le(l+n.exp).map((e=>he(e))),s=t[t.length-1].exp.length-n.exp.length>-1?t[t.length-1].exp.length-n.exp.length:t[t.length-1].exp.length;o=pe(t,e,t.length-1,s,t.length-1)}else if(g)if(c)o=pe(p,a);else{const t=le(n.exp+l).map((e=>he(e)));o=pe(t,e,0,t[0].exp.length,0)}else{const t=le((h&&h.textContent).replace(/\"/g,'""').replace(/\{/g,"{}")).map((e=>he(e)));o=pe(t,e,0,1===t.length?u:t[t.length-1].exp.length,1===t.length?0:t.length-1)}}else{const e=t[a],s=a-1>0?a-1:0,n=t[s],r=$(n),i=$(e);if(r&&i)o=pe(p,a);else if(i)if(r)console.warn("One mergeable part can not be next to another mergeable part");else if(c)o=pe(p,a);else{const e=le(n.exp+l).map((e=>he(e)));o=pe(e,s,0,e[0].exp.length,0)}else if(d)o=pe(p,a);else{const t=le(l+e.exp).map((e=>he(e))),s=t[t.length-1].exp.length-e.exp.length>-1?t[t.length-1].exp.length-e.exp.length:t[t.length-1].exp.length;o=pe(t,a,t.length-1,s,t.length-1)}}return o}(this.id,i,n,r,o,a),p=ce(l,i),c=r?Z(this.id,document&&document.querySelector(`#${this.id}`)):null,d=ie(this.id,r,l,p,c);this.setState({isPopoverOpen:!1,expSelection:d},(()=>{this.setState({isPopoverOpen:!0})})),this.props.onChange(this.getNewExpression(p))},this.onClick=e=>{const t=M(this.id,e.target),s=k(this.id,t);if(!L(s)||s<0)return void((e.target===this.contentEditableContainer.current||this.contentEditableContainer.current.contains(e.target))&&this.setSelectionToEnd());const n=s>-1?R(t,this.contentEditableContainer.current):null;if(n&&this.state.expSelection&&(this.state.expSelection.type!==S.Char||k(this.id,this.state.expSelection.partId)!==s)&&this.props.expression&&this.props.expression.parts&&this.props.expression.parts[s]){const e={partId:t,type:S.Char,startOffset:n.textContent.length};this.setState({expSelection:e,isPopoverOpen:!1},(()=>{this.setState({isPopoverOpen:de(this.props.expression.parts[s].type)})}))}},this.onDoubleClick=e=>{const t=M(this.id,e.target),s=k(this.id,t);if(!L(s)||s<0)return void((e.target===this.contentEditableContainer.current||this.contentEditableContainer.current.contains(e.target))&&this.setSelectionToEnd());const n=s>-1?R(t,this.contentEditableContainer.current):null;if(n){const e={partId:t,type:S.Char,startOffset:n.textContent.length,collapse:!1};this.setState({expSelection:e,isPopoverOpen:!1},(()=>{this.setState({isPopoverOpen:de(this.props.expression.parts[s].type)})}))}},this.onHelperItemSelect=(e,s,n)=>{if(this.props.onChange(e),e&&e.parts&&s){const r=k(this.id,s),i=e.parts[r];if(!i)return void console.warn("Can not move selection because can not find part: ",s);const o=!1;let a={type:S.Char,partId:s,startOffset:i.exp.length};i.type===t.ExpressionPartType.Function&&(n||(a={type:S.Part,partId:A(this.id,k(this.id,s)+1),toStart:!1})),this.setState({expSelection:a,isPopoverOpen:!1},(()=>{this.setState({isPopoverOpen:o})}))}},this.onBlur=e=>{this.props.onChange(this.props.expression)},this.onKeyDown=e=>{if(e.stopPropagation(),e.nativeEvent.stopImmediatePropagation(),["Backspace","Delete","Enter","ArrowLeft","ArrowRight","ArrowUp","ArrowDown"].includes(e.key))e.preventDefault(),"Backspace"!==e.key&&"Delete"!==e.key||function(e){if(!e)return;const t=new Event("input",{bubbles:!0,cancelable:!0});e.dispatchEvent(t)}(e.currentTarget),"Backspace"===e.key?this.handleBackspace():"Delete"===e.key?this.handleDelete():"ArrowLeft"===e.key?this.handleLeftArrow():"ArrowRight"===e.key?this.handleRightArrow():"Enter"===e.key?this.handleEnter():"ArrowDown"===e.key?this.handleDownArrow():"ArrowUp"===e.key&&this.handleUpArrow();else if(e.keyCode>=48&&e.keyCode<=57||e.keyCode>=65&&e.keyCode<=90){Q().collapsed||this.handleBackspace()}},this.handleBackspace=()=>{const e=this.props.expression&&this.props.expression.parts;let t,s;if(this.getWhetherInEditablePart()){const n=Z(this.id,this.contentEditableContainer.current);if(n&&n.partId){const r=n.startOffset===n.endOffset?n.startOffset-1:n.startOffset,i=n.endOffset-1;t=ge(this.id,e,n.partId,r,i),s=i-r+1}}else{const n=ne(this.id),r=re(this.id,e);t=me(this.id,e,n,r),s=0}this.doRemove(t,e,s)},this.handleDelete=()=>{const e=this.props.expression&&this.props.expression.parts;let t,s;if(this.getWhetherInEditablePart()){const n=Z(this.id,this.contentEditableContainer.current);if(n&&n.partId){const r=n.startOffset,i=n.startOffset===n.endOffset?n.endOffset:n.endOffset-1;t=ge(this.id,e,n.partId,r,i),s=r===i?0:i-r+1}}else{const n=ne(this.id),r=re(this.id,e),i=Q(),o=i.collapsed?L(n)?n+1:0:n,a=i.collapsed?L(n)?n+1:0:r;t=me(this.id,e,o,a),s=0}this.doRemove(t,e,s)},this.doRemove=(e,t,s)=>{const n=ce(e,t),r=this.getWhetherInEditablePart(),i=r?Z(this.id,document&&document.querySelector(`#${this.id}`)):null,o=e?ie(this.id,r,e,n,i,s):this.state.expSelection;this.props.onChange(this.getNewExpression(n)),this.setState({isPopoverOpen:!1,expSelection:o},(()=>{this.setState({isPopoverOpen:o.partId&&n[k(this.id,o.partId)]&&de(n[k(this.id,o.partId)].type)})}))},this.handleLeftArrow=()=>{if(this.getWhetherInEditablePart()){const e=Z(this.id,this.contentEditableContainer.current);if(e&&e.partId){const t=e.startOffset-1>-1?{type:S.Char,partId:e.partId,startOffset:e.startOffset-1}:se(this.id,e.partId,!0,0,this.props.expression&&this.props.expression.parts);this.setState({expSelection:t,isPopoverOpen:!1})}}else{const e=ee(this.id);e&&this.setState({expSelection:{partId:e.id,toStart:!0,type:S.Part},isPopoverOpen:!1})}},this.handleRightArrow=()=>{if(this.getWhetherInEditablePart()){const e=Z(this.id,this.contentEditableContainer.current);if(e&&e.partId){const t=e.startOffset+1<=e.contentLength?{type:S.Char,partId:e.partId,startOffset:e.startOffset+1}:se(this.id,e.partId,!1,0,this.props.expression&&this.props.expression.parts);this.setState({expSelection:t,isPopoverOpen:!1})}}else{const e=te(this.id);e&&this.setState({expSelection:{partId:e.id,toStart:!1,type:S.Part},isPopoverOpen:!1})}},this.handleDownArrow=()=>{if(this.state.isPopoverOpen){const e=fe(this.id,this.getWhetherInEditablePart(),this.props.expression&&this.props.expression.parts),t=xe(this.id,e,this.props.expression&&this.props.expression.parts,this.props.useDataSources,this.props.widgetId,this.props.browserSizeMode);let s=this.state.selectedPopoverItemIndex;s=s?parseInt(s)<t.length-1?`${parseInt(this.state.selectedPopoverItemIndex)+1}`:""+(t.length-1):"0",this.setState({selectedPopoverItemIndex:s})}},this.handleUpArrow=()=>{if(this.state.isPopoverOpen){const e=fe(this.id,this.getWhetherInEditablePart(),this.props.expression&&this.props.expression.parts),t=xe(this.id,e,this.props.expression&&this.props.expression.parts,this.props.useDataSources,this.props.widgetId,this.props.browserSizeMode);let s=this.state.selectedPopoverItemIndex;s=s?parseInt(s)>0?""+(parseInt(this.state.selectedPopoverItemIndex)-1):"0":""+(t.length-1),this.setState({selectedPopoverItemIndex:s})}},this.handleEnter=()=>{if(this.state.isPopoverOpen&&this.state.selectedPopoverItemIndex){const e=fe(this.id,this.getWhetherInEditablePart(),this.props.expression&&this.props.expression.parts),t=xe(this.id,e,this.props.expression&&this.props.expression.parts,this.props.useDataSources,this.props.widgetId,this.props.browserSizeMode);this.setState({selectedPopoverItemIndex:null}),this.handlePopoverItemClick(t[this.state.selectedPopoverItemIndex],e)}else{const e=this.props.expression&&this.props.expression.parts&&this.props.expression.parts.length||0;this.setState({isPopoverOpen:!1,expSelection:{partId:this.state.expSelection&&this.state.expSelection.type===S.Char?this.state.expSelection.partId:A(this.id,e>0?e-1:0),toStart:!1,type:S.Part}})}},this.handlePopoverItemClick=(e,t)=>{if(!e||!t)return;const s=this.props.expression&&this.props.expression.parts?this.props.expression.parts.slice():[];e.type===E.Field?this.handleFieldPopoverClick(s,t,e):e.type===E.DataSource?this.handleDsPopoverClick(s,t,e):e.type===E.Function?this.handleFunctionPopoverClick(s,t,e):e.type===E.Order&&this.handleOrderPopoverClick(s,t,e)},this.handleFieldPopoverClick=(e,t,s)=>{e=e||[];const n=k(this.id,t),r=e[n].dataSourceId,i=he(this.getSingleExpFromPopoverItem(s),r,e[n].isFromRepeatedDataSourceContext,s.id);e.splice(n,1,i);const o={partId:A(this.id,n),toStart:!1,type:S.Part};this.setState({isPopoverOpen:!1,expSelection:o}),this.props.onChange(this.getNewExpression(e))},this.handleDsPopoverClick=(e,s,n)=>{e=e||[];const r=k(this.id,s),i=e.slice();if(n.id.split("-").reverse()[0]===t.CONSTANTS.REPEAT_CONTEXT_DATA_VIEW_ID){const e=n.id.split("-").reverse().slice(1).reverse().join("-"),s=J((0,t.Immutable)({dataSourceId:n.id,mainDataSourceId:e,dataViewId:t.CONSTANTS.REPEAT_CONTEXT_DATA_VIEW_ID}),this.props.useDataSources);i[r].isFromRepeatedDataSourceContext=!0,i[r].dataSourceId=s&&s.dataSourceId}else i[r].dataSourceId=n.id;const o={partId:s,type:S.Char,startOffset:i[r].exp.length-1};this.props.onChange(this.getNewExpression(i)),this.setState({isPopoverOpen:!1,expSelection:o},(()=>{this.setState({isPopoverOpen:!0})}))},this.handleFunctionPopoverClick=(e,s,n)=>{e=e||[];const r=k(this.id,s),i=he(this.getSingleExpFromPopoverItem(n)),o={partId:A(this.id,r+1),type:S.Part,toStart:!1};e.splice(r,1,i,{type:t.ExpressionPartType.Operator,exp:"("},{type:t.ExpressionPartType.Operator,exp:")"}),this.props.onChange(this.getNewExpression(e)),this.setState({isPopoverOpen:!1,expSelection:o})},this.handleOrderPopoverClick=(e,t,s)=>{e=e||[];const n=k(this.id,t),r=he(this.getSingleExpFromPopoverItem(s)),i={partId:A(this.id,n),type:S.Part,toStart:!1};e.splice(n,1,r),this.props.onChange(this.getNewExpression(e)),this.setState({isPopoverOpen:!1,expSelection:i})},Se.count++,this.id=`${b}-${Se.count}`,this.contentEditableContainer=t.React.createRef(),this.helperContainer=t.React.createRef(),this.state={isPopoverOpen:!1,isEditorMounted:!1,expSelection:null,selectedPopoverItemIndex:null}}componentDidMount(){this.resizeObserver=new ResizeObserver(this.resizeHelperContainer),this.resizeObserver.observe(this.contentEditableContainer.current),this.expressionString=this.getExpressionString()||"",this.props.autoFocus&&(this.getFocusOnce=!0,this.props.expression&&this.props.expression.parts&&1===this.props.expression.parts.length&&this.props.expression.parts[0].type===t.ExpressionPartType.String?this.setState({expSelection:{partId:A(this.id,0),type:S.Char,startOffset:this.props.expression.parts[0].exp.length-1}}):((0,t.focusElementInKeyboardMode)(this.contentEditableContainer.current,!0),this.setSelectionToEnd())),this.setState({isEditorMounted:!0}),this.contentEditableContainer.current.ondragstart=()=>!1,this.contentEditableContainer.current.onpaste=()=>!1}componentDidUpdate(e,s){this.state.expSelection&&this.state.expSelection.partId&&(s.expSelection!==this.state.expSelection||this.props.autoFocus&&!this.getFocusOnce&&this.getWhetherLoseFocus())&&(this.getFocusOnce=!0,this.state.expSelection.type===S.Part?function(e,s,n){const r=R(e,n);if(r){if(window.getSelection&&document&&document.createRange){const e=document.createRange();r&&(e.selectNode(r),e.collapse(s),window.getSelection().removeAllRanges(),window.getSelection().addRange(e))}}else(0,t.focusElementInKeyboardMode)(n)}(this.state.expSelection.partId,this.state.expSelection.toStart,this.contentEditableContainer.current):this.state.expSelection.type===S.Char&&X(this.state.expSelection.partId,this.state.expSelection.startOffset,this.contentEditableContainer.current,this.state.expSelection.collapse)),e.expression!==this.props.expression&&(this.props.expression&&this.props.expression.parts?this.expressionString=this.getExpressionString():this.expressionString="")}componentWillUnmount(){this.resizeObserver.disconnect()}render(){var e;let s;this.state.isPopoverOpen&&(s=fe(this.id,this.getWhetherInEditablePart(),this.props.expression&&this.props.expression.parts));let n=this.renderPartsToHtml(this.props.expression&&this.props.expression.parts);n=n&&n.replace(/&quot;/g,'"');const r=t.expressionUtils.getWhetherExpressionValid(this.props.expression);return(0,t.jsx)(t.MultipleDataSourceComponent,{useDataSources:this.props.useDataSources},(0,t.jsx)("div",{style:this.props.style,onClick:this.onClick,className:(0,t.classNames)("w-100 h-100",{[this.props.className]:!!this.props.className})},(0,t.jsx)("div",{className:"w-100 h-100 component-expression-editor"},(0,t.jsx)("div",{className:(0,t.classNames)("w-100 expression-editor-input",{"error-border":!r})},(0,t.jsx)(y(),{innerRef:this.contentEditableContainer,html:n,disabled:!(!this.state.expSelection||this.state.expSelection.type!==S.Char),onChange:this.onChange,onKeyDown:this.onKeyDown,onBlur:this.onBlur,onDoubleClick:this.onDoubleClick,className:"w-100 break-all expression-editor-input-content-editable",style:this.ltrStyle}),(0,t.jsx)(D,{targetNodeId:s,containerNode:null===(e=this.contentEditableContainer)||void 0===e?void 0:e.current,expSelection:this.state.expSelection,items:xe(this.id,s,this.props.expression&&this.props.expression.parts,this.props.useDataSources,this.props.widgetId,this.props.browserSizeMode),isOpen:this.state.isPopoverOpen,onClick:this.handlePopoverItemClick,theme:this.props.theme,selectedItemIndex:this.state.selectedPopoverItemIndex})),!r&&(0,t.jsx)("div",{className:"mt-1 error-message",ref:this.errorMsgContainer},this.props.intl.formatMessage({id:"invalidExpression",defaultMessage:l.defaultMessages.invalidExpression})),(0,t.jsx)("div",{className:(0,t.classNames)("expression-editor-helper mt-4",{"with-error-message":!r}),ref:this.helperContainer},(0,t.jsx)(ye,{expression:this.props.expression,useDataSources:this.props.useDataSources,onSelect:this.onHelperItemSelect,intl:this.props.intl,externalId:this.id,inEditablePart:this.getWhetherInEditablePart(),container:this.state.isEditorMounted?this.contentEditableContainer.current:null,expSelection:this.state.expSelection,widgetId:this.props.widgetId})))))}}Se.count=-1;const Ee=t.ReactRedux.connect(((e,t)=>{var s,n;return{browserSizeMode:(null===(s=null==e?void 0:e.appContext)||void 0===s?void 0:s.isBuilder)?null===(n=null==e?void 0:e.appStateInBuilder)||void 0===n?void 0:n.browserSizeMode:null==e?void 0:e.browserSizeMode}}))(Se),Ce=(0,a.withTheme)((0,a.withStyles)((0,t.injectIntl)(Ee),"ExpressionEditor"));class Ie extends t.React.PureComponent{constructor(e){super(e),this.__unmount=!1,this.getSelectedFields=()=>{if(!this.props.expression||!this.props.useDataSources)return null;const e=this.props.expression.parts&&this.props.expression.parts[0],s=e&&u(e,this.props.useDataSources)&&e.type===t.ExpressionPartType.Field?e.jimuFieldName:null;if(s){const n=e.dataSourceId;return{fields:n?(0,t.Immutable)({[n]:[s]}):null,isSelectedFromRepeatedDataSourceContext:e.isFromRepeatedDataSourceContext}}return null},this.onSelectedFieldsChange=(e,s,n)=>{const r=e&&e[0];if(!r||!s)return;const i={type:t.ExpressionPartType.Field,exp:`{${r.alias||r.name}}`,dataSourceId:s.id,jimuFieldName:r.jimuName,isFromRepeatedDataSourceContext:!!n};this.props.onChange({name:i.exp,parts:[i]})},this.state={FieldSelector:null}}componentDidMount(){this.__unmount=!1,t.moduleLoader.loadModule("jimu-ui/advanced/data-source-selector").then((e=>{!this.__unmount&&this.setState({FieldSelector:e.FieldSelector})}))}componentWillUnmount(){this.__unmount=!0}render(){const e=this.state.FieldSelector,s=this.getSelectedFields();return t.React.createElement("div",{className:(0,t.classNames)(["expression-builder-tab attribute-tab common-tab p-0",this.props.className])},t.React.createElement("div",{className:"field-selector-container pb-4"},e&&t.React.createElement(e,{types:this.props.types,useDataSources:this.props.useDataSources,widgetId:this.props.widgetId,onChange:this.onSelectedFieldsChange,selectedFields:null==s?void 0:s.fields,isSelectedFromRepeatedDataSourceContext:null==s?void 0:s.isSelectedFromRepeatedDataSourceContext,useSelectionDataView:!0,usePopulatedDataView:!0})))}}var we=p(93303),Ne=p.n(we),Oe=function(e,t){var s={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(s[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(n=Object.getOwnPropertySymbols(e);r<n.length;r++)t.indexOf(n[r])<0&&Object.prototype.propertyIsEnumerable.call(e,n[r])&&(s[n[r]]=e[n[r]])}return s};const Te=e=>{const s=window.SVG,{className:n}=e,r=Oe(e,["className"]),i=(0,t.classNames)("jimu-icon jimu-icon-component",n);return s?t.React.createElement(s,Object.assign({className:i,src:Ne()},r)):t.React.createElement("svg",Object.assign({className:i},r))},je={useGrouping:!0,notation:"standard",minimumFractionDigits:0,maximumFractionDigits:4};class De extends t.React.PureComponent{constructor(e){var s,n,r,i,o,p;super(e),this.numberFormatBtnRef=t.React.createRef(),this.expressionCountAdded=!1,this.insertCount=0,this.theme=window.jimuConfig.isBuilder?(0,a.getTheme)():(0,a.getTheme2)(),this.numberFormatStyles=t.css`
    width: ${t.polished.rem(240)};
    padding: ${t.polished.rem(16)};
    .number-format-switch-label{
      font-size: ${t.polished.rem(14)};
      font-weight: 600;
      color: ${(null===(s=this.theme)||void 0===s?void 0:s.ref.palette.neutral[1100])||"#dcdcdc"};
    }
    .number-format-checkbox-label{
      font-size: ${t.polished.rem(13)};
      color: ${(null===(n=this.theme)||void 0===n?void 0:n.ref.palette.neutral[1100])||"#dcdcdc"};
    }
    .number-format-numeric-input-label{
      font-size: ${t.polished.rem(13)};
      color: ${(null===(r=this.theme)||void 0===r?void 0:r.ref.palette.neutral[900])||"#a0a0a0"};
    }
  `,this.getMutableExpression=e=>this.props.expression&&this.props.expression.asMutable?this.props.expression.asMutable({deep:!0}):this.props.expression,this.onExpChange=e=>{this.setState({expression:e})},this.onChange=()=>{const e={name:this.state.name||this.getDefaultName(),parts:this.state.expression&&this.state.expression.parts};this.state.numberFormat&&(e.numberFormat=this.state.numberFormat),this.insertCount++,this.props.onChange(e)},this.onNameChange=e=>{this.setState({name:e.target.value})},this.getDefaultName=()=>`${this.props.intl.formatMessage({id:"expression",defaultMessage:l.defaultMessages.expression})} ${De.count}`,this.getWhetherDisableInsert=()=>!this.state.expression||!this.state.expression.parts||0===this.state.expression.parts.length||!t.expressionUtils.getWhetherExpressionValid(this.state.expression),this.onNumberFormatClick=()=>{this.toggleNumberFormatSettingPopper()},this.toggleNumberFormatSettingPopper=()=>{this.setState({isNumberFormatSettingOpen:!this.state.isNumberFormatSettingOpen})},this.onToggleNumberFormatSetting=(e,t)=>{t?this.setState({numberFormat:je}):this.setState({numberFormat:null})},this.onMinDigitsChange=e=>{this.setState({numberFormat:Object.assign(Object.assign({},this.state.numberFormat),{minimumFractionDigits:e})})},this.onMaxDigitsChange=e=>{this.setState({numberFormat:Object.assign(Object.assign({},this.state.numberFormat),{maximumFractionDigits:e})})},this.onUseGroupChange=(e,t)=>{this.setState({numberFormat:Object.assign(Object.assign({},this.state.numberFormat),{useGrouping:t})})},this.onNotationChange=(e,t)=>{this.setState({numberFormat:Object.assign(Object.assign({},this.state.numberFormat),{notation:t?"compact":"standard"})})},(null===(i=e.expression)||void 0===i?void 0:i.name)||(De.count++,this.expressionCountAdded=!0),this.state={expression:this.getMutableExpression(this.props.expression),name:(null===(o=this.props.expression)||void 0===o?void 0:o.name)||this.getDefaultName(),numberFormat:null===(p=this.props.expression)||void 0===p?void 0:p.numberFormat,isNumberFormatSettingOpen:!1}}componentDidUpdate(e){var t,s;e.expression!==this.props.expression&&this.setState({expression:this.getMutableExpression(this.props.expression),name:(null===(t=this.props.expression)||void 0===t?void 0:t.name)||this.getDefaultName(),numberFormat:null===(s=this.props.expression)||void 0===s?void 0:s.numberFormat})}componentWillUnmount(){this.expressionCountAdded&&0===this.insertCount&&De.count--}render(){var e,s;const n=this.props.intl.formatMessage({id:"numberFormatting",defaultMessage:l.defaultMessages.numberFormatting}),r=this.props.intl.formatMessage({id:"decimalPlace",defaultMessage:l.defaultMessages.decimalPlace}),i=this.props.intl.formatMessage({id:"showThousandSeparator",defaultMessage:l.defaultMessages.showThousandSeparator}),o=this.props.intl.formatMessage({id:"unit",defaultMessage:l.defaultMessages.unit}),a=this.props.intl.formatMessage({id:"to",defaultMessage:l.defaultMessages.to}),p=`expression-${De.count}-number-format-decimal`;return(0,t.jsx)("div",{className:"expression-builder-tab expression-tab px-4"},(0,t.jsx)("div",{className:"mb-4"},(0,t.jsx)("div",{className:"d-flex justify-content-start"},(0,t.jsx)(l.TextInput,{className:"flex-grow-1",value:this.state.name,onChange:this.onNameChange,id:"expression-name-input",size:"sm"}))),(0,t.jsx)("div",{className:"expression-editor-container"},(0,t.jsx)(Ce,Object.assign({},this.props,{expression:this.state.expression,onChange:this.onExpChange,autoFocus:this.props.isActive}))),(0,t.jsx)("div",{className:"fixed-at-bottom d-flex align-items-center justify-content-between px-4"},(0,t.jsx)(l.Button,{type:"default",icon:!0,size:"default",onClick:this.onNumberFormatClick,title:n,"aria-label":n,ref:this.numberFormatBtnRef},(0,t.jsx)(Te,{size:"m"})),(0,t.jsx)(l.Button,{onClick:this.onChange,type:"primary",disabled:this.getWhetherDisableInsert(),className:"expression-insert-btn ml-2",size:"default",title:this.props.intl.formatMessage({id:"insert",defaultMessage:l.defaultMessages.insert})},(0,t.jsx)("div",{className:"text-truncate"},this.props.intl.formatMessage({id:"insert",defaultMessage:l.defaultMessages.insert})))),(0,t.jsx)(l.Popper,{reference:this.numberFormatBtnRef.current,open:this.state.isNumberFormatSettingOpen,arrowOptions:!0,toggle:this.toggleNumberFormatSettingPopper,offsetOptions:[-8,0],placement:"top-start",autoUpdate:!0},(0,t.jsx)("div",{css:this.numberFormatStyles},(0,t.jsx)("div",{className:"w-100 mb-2"},(0,t.jsx)(l.Label,{className:"w-100 d-flex justify-content-between"},(0,t.jsx)("div",{className:"w-75 text-truncate number-format-switch-label",title:n},n),(0,t.jsx)(l.Switch,{checked:!!this.state.numberFormat,onChange:this.onToggleNumberFormatSetting}))),this.state.numberFormat&&(0,t.jsx)("div",{className:"w-100"},(0,t.jsx)("div",{className:"w-100 mb-2 d-flex"},(0,t.jsx)(l.Label,{className:"w-100 text-truncate m-0 number-format-numeric-input-label",for:p},r)),(0,t.jsx)("div",{className:"w-100 d-flex justify-content-between mb-4",id:p},(0,t.jsx)(l.NumericInput,{value:this.state.numberFormat.minimumFractionDigits,onChange:this.onMinDigitsChange,showHandlers:!0,precision:0,min:0,max:null!==(e=this.state.numberFormat.maximumFractionDigits)&&void 0!==e?e:20,size:"sm"}),(0,t.jsx)("span",{className:"mx-2 number-format-numeric-input-label"},a),(0,t.jsx)(l.NumericInput,{value:this.state.numberFormat.maximumFractionDigits,onChange:this.onMaxDigitsChange,showHandlers:!0,precision:0,min:null!==(s=this.state.numberFormat.minimumFractionDigits)&&void 0!==s?s:0,max:20,size:"sm"})),(0,t.jsx)("div",{className:"w-100 mb-2"},(0,t.jsx)(l.Label,{className:"w-100 d-flex justify-content-start m-0"},(0,t.jsx)(l.Checkbox,{className:"mr-2",checked:!!this.state.numberFormat.useGrouping,onChange:this.onUseGroupChange}),(0,t.jsx)("div",{className:"w-85 text-truncate number-format-checkbox-label",title:i},i))),(0,t.jsx)("div",{className:"w-100"},(0,t.jsx)(l.Label,{className:"w-100 d-flex justify-content-start m-0"},(0,t.jsx)(l.Checkbox,{className:"mr-2",checked:"compact"===this.state.numberFormat.notation,onChange:this.onNotationChange}),(0,t.jsx)("div",{className:"w-85 text-truncate number-format-checkbox-label",title:o},o)))))))}}De.count=0;const Pe=De,Fe="ASC";class Re extends t.React.PureComponent{constructor(e){var s;super(e),this.dsManager=t.DataSourceManager.getInstance(),this.__unmount=!1,this.getWhetherExpressionIsFuncAndHasOnePart=e=>!!e&&!(1!==e.length||!e[0]||e[0].type!==t.ExpressionPartType.Function),this.hasNoParamAndDsEnabled=e=>!!e&&((!e.parts||0===e.parts.length)&&u(e,this.props.useDataSources)),this.hasParamsAndDsEnabled=e=>!!e&&(e.parts&&e.parts.length&&u(e.parts[0],this.props.useDataSources)),this.getWhetherUseSelectedDs=e=>!this.state||!this.state.selectedDsId||e.dataSourceId===this.state.selectedDsId,this.getDefaultDsId=()=>{const e=this.props.expression&&this.props.expression.parts,s=(0,t.groupExpressionPartsByFunction)(e);if(this.getWhetherExpressionIsFuncAndHasOnePart(s)){const e=s[0];if(this.hasNoParamAndDsEnabled(e))return e.dataSourceId;if(this.hasParamsAndDsEnabled(e))return e.parts[0].dataSourceId}return null},this.getDefaultFunc=()=>{const e=this.props.expression&&this.props.expression.parts,s=(0,t.groupExpressionPartsByFunction)(e);if(this.getWhetherExpressionIsFuncAndHasOnePart(s)){return s[0].exp||t.ExpressionFunctions.Average}return t.ExpressionFunctions.Average},this.getDefaultPercentileParams=()=>{const e=this.props.expression&&this.props.expression.parts,s=(0,t.groupExpressionPartsByFunction)(e);if(this.getWhetherExpressionIsFuncAndHasOnePart(s)){const e=s[0],n=e.exp,r=e.parts,i=t.expressionUtils.getPercentileParams(r,n)||{};return("number"!=typeof i.value||isNaN(i.value))&&(i.value=50),i.orderBy||(i.orderBy=Fe),i}return{value:50,orderBy:Fe}},this.getDefaultJimuFieldName=e=>{const s=this.props.expression&&this.props.expression.parts,n=(0,t.groupExpressionPartsByFunction)(s),r=n[0],i=t.DataSourceManager.getInstance().getDataSource(e),o=null==i?void 0:i.getIdField();return this.getWhetherExpressionIsFuncAndHasOnePart(n)&&this.hasParamsAndDsEnabled(r)&&this.getWhetherUseSelectedDs(r.parts[0])&&r.parts[0].jimuFieldName||o},this.getDefaultExpName=(e,t,s,n)=>m(t)?n!==Fe?`${t}({${e}}, ${s}, ${n})`:`${t}({${e}}, ${s})`:`${t}({${e}})`,this.getCustomExpName=(e,t,s,n,r)=>r===this.getDefaultExpName(e,t,s,n)?"":r||"",this.getSelectedFieldName=(e,t)=>e?t&&e[t]&&(e[t].alias||e[t].name):"",this.getFieldsByFunc=(e,s)=>{if(!e)return{};const n=this.dsManager&&this.dsManager.getDataSource(e),r=n&&n.getSchema(),i=r&&r.fields;if(!i)return{};if(s===t.ExpressionFunctions.Count)return i.asMutable({deep:!0});const o={},a=s===t.ExpressionFunctions.Min||s===t.ExpressionFunctions.Max;return Object.keys(i).forEach((e=>{(i[e].type===t.JimuFieldType.Number||a&&(i[e].type===t.JimuFieldType.Date||i[e].type===t.JimuFieldType.DateOnly||i[e].type===t.JimuFieldType.TimeOnly))&&(o[e]=i[e])})),o},this.getSelectedUseDataSource=()=>{var e;const s=t.DataSourceManager.getInstance().getDataSource(this.state.selectedDsId);return this.state.selectedDsId&&s?(0,t.Immutable)({dataSourceId:s.id,mainDataSourceId:s.getMainDataSource().id,dataViewId:s.dataViewId,rootDataSourceId:null===(e=s.getRootDataSource())||void 0===e?void 0:e.id}):null},this.onFieldChange=e=>{const t=e.currentTarget.value;this.setState({selectedJimuFieldName:t})},this.onFunctionChange=e=>{const t=e.currentTarget.value;this.setState({selectedFunction:t})},this.onPercentileValueChange=e=>{this.setState({percentileValue:e})},this.onPercentileOrderChange=e=>{const t=e.currentTarget.value;this.setState({percentileOrder:t})},this.onCustomExpNameChange=e=>{this.setState({customExpName:e.target.value})},this.onChange=()=>{const e=this.getFieldsByFunc(this.state.selectedDsId,this.state.selectedFunction),s=this.getSelectedFieldName(e,this.state.selectedJimuFieldName),n=this.state.customExpName||this.getDefaultExpName(s,this.state.selectedFunction,this.state.percentileValue,this.state.percentileOrder),r=[{type:t.ExpressionPartType.Function,exp:this.state.selectedFunction},{type:t.ExpressionPartType.Operator,exp:"("},{type:t.ExpressionPartType.Field,exp:`{${s}}`,dataSourceId:this.state.selectedDsId,jimuFieldName:this.state.selectedJimuFieldName}];m(this.state.selectedFunction)&&(r.push({type:t.ExpressionPartType.Operator,exp:","},{type:t.ExpressionPartType.Number,exp:`${this.state.percentileValue}`}),this.state.percentileOrder!==Fe&&r.push({type:t.ExpressionPartType.Operator,exp:","},{type:t.ExpressionPartType.Order,exp:this.state.percentileOrder})),r.push({type:t.ExpressionPartType.Operator,exp:")"}),this.props.onChange({name:n,parts:r})},this.onSelectedUseDsChange=e=>{this.setState({selectedDsId:null==e?void 0:e.dataSourceId})};const n=this.getDefaultDsId(),r=this.getDefaultJimuFieldName(n),i=this.getDefaultFunc(),o=this.getDefaultPercentileParams(),a=o.value,l=o.orderBy,p=this.getFieldsByFunc(n,i),c=this.getSelectedFieldName(p,r);this.state={customExpName:this.getCustomExpName(c,i,a,l,null===(s=this.props.expression)||void 0===s?void 0:s.name),selectedDsId:n,selectedJimuFieldName:r||"",selectedFunction:i,MainDataAndViewSelector:null,DataViewPriority:null,percentileValue:a,percentileOrder:l}}componentDidMount(){this.__unmount=!1,t.moduleLoader.loadModule("jimu-ui/advanced/data-source-selector").then((e=>{!this.__unmount&&this.setState({MainDataAndViewSelector:e.MainDataAndViewSelector,DataViewPriority:e.DataViewPriority})}))}componentDidUpdate(e,t){var s;if(e.expression!==this.props.expression||e.useDataSources!==this.props.useDataSources){const e=this.getDefaultDsId(),t=this.getDefaultJimuFieldName(e),n=this.getDefaultFunc(),r=this.getDefaultPercentileParams(),i=r.value,o=r.orderBy,a=this.getFieldsByFunc(e,n),l=this.getSelectedFieldName(a,t);this.setState({customExpName:this.getCustomExpName(l,n,i,o,null===(s=this.props.expression)||void 0===s?void 0:s.name),selectedDsId:e,selectedJimuFieldName:t,selectedFunction:n,percentileValue:i,percentileOrder:o})}if(t.selectedDsId!==this.state.selectedDsId){const e=this.getDefaultJimuFieldName(this.state.selectedDsId);this.setState({selectedJimuFieldName:e})}}componentWillUnmount(){this.__unmount=!0}render(){const e=this.getFieldsByFunc(this.state.selectedDsId,this.state.selectedFunction),s=this.state.MainDataAndViewSelector,n=this.state.DataViewPriority,r=this.getSelectedFieldName(e,this.state.selectedJimuFieldName);return t.React.createElement("div",{className:"expression-builder-tab statistics-tab common-tab"},t.React.createElement("div",{className:"data-option expression-name"},t.React.createElement("div",{className:"flex-grow-1"},t.React.createElement(l.TextInput,{placeholder:this.getDefaultExpName(r,this.state.selectedFunction,this.state.percentileValue,this.state.percentileOrder),value:this.state.customExpName,className:"flex-grow-1",size:"sm",onChange:this.onCustomExpNameChange}))),s&&t.React.createElement(s,{useDataSources:this.props.useDataSources,onChange:this.onSelectedUseDsChange,useSelectionDataView:!0,className:"p-4",selectedUseDataSource:this.getSelectedUseDataSource(),defaultDataViewPriority:n.Second}),t.React.createElement("div",{className:"data-option mb-3"},t.React.createElement("div",{className:"w-100 text-truncate mb-3 option-label"},this.props.intl.formatMessage({id:"operator",defaultMessage:l.defaultMessages.operator})),t.React.createElement("div",{className:"flex-grow-1"},t.React.createElement(l.Select,{value:this.state.selectedFunction,className:"select-max-width",size:"sm",onChange:this.onFunctionChange},function(e){var s,n;const r=t.DataSourceManager.getInstance().getDataSource(e);if(null===(n=null===(s=null==r?void 0:r.getCapabilities)||void 0===s?void 0:s.call(r))||void 0===n?void 0:n.getQueryCapabilities().supportsPercentileStatistics)return Object.values(t.ExpressionFunctions);{const e=Object.assign({},t.ExpressionFunctions);return delete e.PercentileContinuous,delete e.PercentileDiscrete,Object.values(e)}}(this.state.selectedDsId).map(((e,s)=>t.React.createElement(l.Option,{value:e,key:s,className:"select-max-width text-truncate"},e)))))),t.React.createElement("div",{className:"data-option mb-3"},t.React.createElement("div",{className:"w-100 text-truncate mb-3 option-label"},this.props.intl.formatMessage({id:"field",defaultMessage:l.defaultMessages.field})),t.React.createElement("div",{className:"flex-grow-1"},t.React.createElement(l.Select,{value:this.state.selectedJimuFieldName,size:"sm",onChange:this.onFieldChange,className:"select-max-width"},e&&Object.keys(e).map(((s,n)=>t.React.createElement(l.Option,{value:e[s].jimuName,key:n,className:"select-max-width",title:e[s].alias||e[s].name},t.React.createElement("div",{className:"text-truncate"},e[s].alias||e[s].name))))))),m(this.state.selectedFunction)&&t.React.createElement("div",{className:"data-option mb-3"},t.React.createElement("div",{className:"w-100 text-truncate mb-3 option-label"},this.props.intl.formatMessage({id:"percentileValue",defaultMessage:l.defaultMessages.percentileValue})),t.React.createElement("div",{className:"flex-grow-1"},t.React.createElement(l.NumericInput,{value:this.state.percentileValue,className:"w-100",min:0,max:100,precision:0,onChange:this.onPercentileValueChange}))),m(this.state.selectedFunction)&&t.React.createElement("div",{className:"data-option mb-3"},t.React.createElement("div",{className:"w-100 text-truncate mb-3 option-label"},this.props.intl.formatMessage({id:"orderBy",defaultMessage:l.defaultMessages.orderBy})),t.React.createElement("div",{className:"flex-grow-1"},t.React.createElement(l.Select,{value:this.state.percentileOrder,size:"sm",onChange:this.onPercentileOrderChange,className:"select-max-width"},["ASC","DESC"].map(((e,s)=>t.React.createElement(l.Option,{value:e,key:s,className:"select-max-width",title:e},t.React.createElement("div",{className:"text-truncate"},e))))))),t.React.createElement("div",{className:"data-option w-100 mt-2 d-flex justify-content-end"},t.React.createElement(l.Button,{onClick:this.onChange,type:"primary",className:"stat-inter-btn",title:this.props.intl.formatMessage({id:"insert",defaultMessage:l.defaultMessages.insert}),disabled:!Object.keys(e||{}).includes(this.state.selectedJimuFieldName)},t.React.createElement("div",{className:"text-truncate"},this.props.intl.formatMessage({id:"insert",defaultMessage:l.defaultMessages.insert})))))}}class Me extends t.React.PureComponent{constructor(e){super(e),this.expressionFrom={[i.Attribute]:this.props.intl.formatMessage({id:"attribute",defaultMessage:l.defaultMessages.attribute}),[i.Statistics]:this.props.intl.formatMessage({id:"statistics",defaultMessage:l.defaultMessages.statistics}),[i.Expression]:this.props.intl.formatMessage({id:"expression",defaultMessage:l.defaultMessages.expression})},this.onChange=e=>{this.props.onChange&&this.props.onChange(e)},this.getActiveExpressionFrom=(e,s)=>{if(!e||!e.parts||0===e.parts.length)return this.props.types[0];if(e.numberFormat)return this.props.types.some((e=>e===i.Expression))?i.Expression:s[0];const n=(0,t.groupExpressionPartsByFunction)(e.parts);return 1===n.length&&n[0].type===t.ExpressionPartType.Field?s.some((e=>e===i.Attribute))?i.Attribute:s.some((e=>e===i.Expression))?i.Expression:s[0]:1===n.length&&n[0].type===t.ExpressionPartType.Function&&s.some((e=>e===i.Statistics))?i.Statistics:s.some((e=>e===i.Expression))?i.Expression:s[0]},this.getTabsContent=(e,s,n,r)=>1===(null==e?void 0:e.length)?(0,t.jsx)("div",{className:(0,t.classNames)("h-100",{"has-nav":e&&e.length>1})},this.getSingleTab(e[0],!0,n,r)):(null==e?void 0:e.length)>1?(0,t.jsx)(l.Tabs,{fill:!0,type:"underline",className:"h-100",value:s,onChange:this.onActiveTabChange},e.asMutable().map((i=>{const o=this.expressionFrom[i];return(0,t.jsx)(l.Tab,{id:i,title:o,key:i},(0,t.jsx)("div",{className:(0,t.classNames)("h-100",{"has-nav":(null==e?void 0:e.length)>1})},this.getSingleTab(i,i===s,n,r)))}))):void 0,this.getSingleTab=(e,s,n,r)=>{switch(e){case i.Attribute:return(0,t.jsx)(Ie,{types:this.props.fieldTypes,useDataSources:n,expression:r,onChange:this.onChange,intl:this.props.intl,widgetId:this.props.widgetId});case i.Statistics:return(0,t.jsx)(Re,{useDataSources:n,expression:r,onChange:this.onChange,intl:this.props.intl,widgetId:this.props.widgetId});case i.Expression:return(0,t.jsx)(Pe,Object.assign({},this.props,{useDataSources:n,expression:r,onChange:this.onChange,intl:this.props.intl,isActive:s}));default:return null}},this.onActiveTabChange=e=>{this.setState({activeTab:e})};const s=this.getActiveExpressionFrom(this.props.expression,this.props.types);this.state={activeTab:s,content:this.getTabsContent(this.props.types,s,this.props.useDataSources,this.props.expression)}}componentDidUpdate(e,t){this.props.types===e.types&&this.props.expression===e.expression||this.setState({activeTab:this.getActiveExpressionFrom(this.props.expression,this.props.types)}),this.props.types===e.types&&this.props.expression===e.expression&&this.props.useDataSources===e.useDataSources&&this.state.activeTab===t.activeTab||this.setState({content:this.getTabsContent(this.props.types,this.state.activeTab,this.props.useDataSources,this.props.expression)})}render(){return(0,t.jsx)(t.MultipleDataSourceComponent,{useDataSources:this.props.useDataSources},(0,t.jsx)("div",{style:this.props.style,className:(0,t.classNames)("w-100 h-100",{[this.props.className]:!!this.props.className})},(0,t.jsx)("div",{className:"w-100 h-100 component-expression-builder"},this.state.content)))}}const Ae=(0,t.injectIntl)((0,a.withStyles)(Me,"ExpressionBuilder"));class ke extends t.React.PureComponent{constructor(e){super(e),this.overflowYStyle={overflow:"hidden"},this.__unmount=!1,this.state={SidePopper:null}}componentDidMount(){this.__unmount=!1,t.moduleLoader.loadModule("jimu-ui/advanced/setting-components").then((e=>{!this.__unmount&&this.setState({SidePopper:e.SidePopper})}))}componentWillUnmount(){this.__unmount=!0}render(){const e=this.state.SidePopper,s=this.props.types,n=s?s.length>1?this.props.intl.formatMessage({id:"dynamicContent",defaultMessage:l.defaultMessages.dynamicContent}):h(s[0],this.props.intl):"";return(0,t.jsx)("div",{className:"w-100 h-100"},e&&(0,t.jsx)(e,{isOpen:this.props.isOpen&&!t.urlUtils.getAppIdPageIdFromUrl().pageId,position:"right",toggle:this.props.onClose,trigger:this.props.trigger,backToFocusNode:this.props.backToFocusNode,title:n},(0,t.jsx)("div",{className:"h-100 bg-default border-color-gray-400 component-expression-builder-popup"},(0,t.jsx)("div",{className:"w-100 h-100 expression-popup"},(0,t.jsx)("div",{style:this.overflowYStyle,className:"h-100"},(0,t.jsx)(Ae,Object.assign({},this.props)))))))}}const _e=(0,a.withTheme)((0,t.injectIntl)(ke));var $e=p(28938),Be=p.n($e),Le=p(94747),Ve=p.n(Le),Ue=p(3800),He=p.n(Ue),We=p(54207),ze=p.n(We),qe=p(3637),Je=p.n(qe),Ke=p(42018);class Ge extends t.React.PureComponent{constructor(e){super(e),this.expBuilderTrigger=t.React.createRef(),this.dropdownButton=t.React.createRef(),this.toggleDropdown=()=>{this.setState({isDropdownOpen:!this.state.isDropdownOpen})},this.getExpFromIcon=e=>{switch(e){case d.Static:return Be();case d.Attribute:return ze();case d.Statistics:return Ve();case d.Expression:return Je();case d.Arcade:return He();default:return null}},this.getSelectedExpFromExpression=()=>{var e;if(null===(e=this.props.expression)||void 0===e?void 0:e.numberFormat)return this.props.types.some((e=>e===d.Expression))?d.Expression:this.props.types[0];if(!this.props.expression||!this.props.expression.parts||0===this.props.expression.parts.length)return this.props.types.some((e=>e===d.Static))?d.Static:this.props.types.some((e=>e===d.Attribute))?d.Attribute:this.props.types.some((e=>e===d.Statistics))?d.Statistics:this.props.types.some((e=>e===d.Expression))?d.Expression:this.props.types[0];if(t.expressionUtils.isSingleArcadeExpression(this.props.expression))return d.Arcade;const s=(0,t.groupExpressionPartsByFunction)(this.props.expression.parts);return 1===s.length&&s[0].type===t.ExpressionPartType.Field?this.props.types.some((e=>e===d.Attribute))?d.Attribute:this.props.types.some((e=>e===d.Expression))?d.Expression:this.props.types[0]:1===s.length&&s[0].type===t.ExpressionPartType.Function?this.props.types.some((e=>e===d.Statistics))?d.Statistics:this.props.types.some((e=>e===d.Expression))?d.Expression:this.props.types[0]:1===s.length&&s[0].type===t.ExpressionPartType.String&&this.props.types.some((e=>e===d.Static))?d.Static:this.props.types.some((e=>e===d.Expression))?d.Expression:this.props.types[0]},this.getWhetherFromExpBuilder=(e,t)=>(null==t?void 0:t.length)>0&&e&&Object.keys(i).some((t=>i[t]===e)),this.getWhetherFromArcade=(e,t)=>(null==t?void 0:t.length)>0&&e===d.Arcade,this.getWhetherFromDynammic=(e,t)=>this.getWhetherFromArcade(e,t)||this.getWhetherFromExpBuilder(e,t),this.getExpressionFrom=()=>this.getWhetherFromExpBuilder(this.state.selectedExpFrom,this.props.useDataSources)?(0,t.Immutable)([this.state.selectedExpFrom]):(0,t.Immutable)([]),this.getStringFromExpression=()=>this.props.expression&&1===this.props.expression.parts.length&&this.props.expression.parts[0].type===t.ExpressionPartType.String?this.props.expression.parts[0].exp.replace(/^"/,"").replace(/"$/,""):"",this.onInputBlur=e=>{const s=e.target.value,n={name:s,parts:[{type:t.ExpressionPartType.String,exp:`"${s}"`}]};this.props.onChange&&this.props.onChange(n)},this.onInputChange=e=>{this.setState({inputValue:e.target.value})},this.onExpChange=e=>{this.props.onChange&&this.props.onChange(e)},this.onArcadeChange=e=>{if(e){const s=t.expressionUtils.arcadeConfigToExpression(e);this.props.onChange&&this.props.onChange(s)}else this.props.onChange&&this.props.onChange({name:"",parts:[]})},this.onExpFromChange=e=>{e!==this.state.selectedExpFrom?(e!==d.Expression&&this.onExpChange({name:"",parts:[]}),this.setState({selectedExpFrom:e},(()=>{e===d.Static?this.props.closeExpPopup():this.props.openExpPopup()}))):this.toggleExpPopup()},this.getWhetherExpDssMatchInUseDss=e=>{const t=e&&e.parts;return!!t&&t.every((e=>u(e,this.props.useDataSources)))},this.toggleExpPopup=()=>{this.getWhetherFromDynammic(this.state.selectedExpFrom,this.props.useDataSources)?this.props.isExpPopupOpen?this.props.closeExpPopup():this.props.openExpPopup():this.props.closeExpPopup()},this.state={selectedExpFrom:this.getSelectedExpFromExpression(),isDropdownOpen:!1,inputValue:this.getStringFromExpression()}}componentDidUpdate(e,t){t.selectedExpFrom===d.Static&&this.state.selectedExpFrom!==d.Static&&this.setState({inputValue:""})}render(){var e;const{placeHolders:s={},autoHide:n}=this.props,{selectedExpFrom:r}=this.state,i=this.getWhetherFromExpBuilder(this.state.selectedExpFrom,this.props.useDataSources),o=this.getWhetherFromArcade(this.state.selectedExpFrom,this.props.useDataSources),a=i||o,p=i&&(!t.expressionUtils.getWhetherExpressionValid(this.props.expression)||!this.getWhetherExpDssMatchInUseDss(this.props.expression)),c=a?this.props.expression&&this.props.expression.name||"":this.state.inputValue,d=n&&(this.props.types||[]).length<=1||!(null===(e=this.props.useDataSources)||void 0===e?void 0:e.length);return(0,t.jsx)("div",{style:this.props.style,ref:this.expBuilderTrigger,className:(0,t.classNames)("w-100 h-100",{[this.props.className]:!!this.props.className})},(0,t.jsx)("div",{className:"d-flex justify-content-start align-items-center component-expression-input"},!d&&(0,t.jsx)("div",{className:"expression-builder-trigger"},(0,t.jsx)(l.Dropdown,{isOpen:this.state.isDropdownOpen,toggle:this.toggleDropdown,className:"w-100 h-100 expression-builder-trigger-dropdown"},(0,t.jsx)(l.DropdownButton,{arrow:!1,dot:!0,icon:!0,ref:this.dropdownButton,title:h(this.state.selectedExpFrom,this.props.intl),className:"text-truncate d-flex justify-content-center align-items-center trigger-dropdown-toggle p-0 jimu-outline-inside"},r&&(0,t.jsx)(l.Icon,{icon:this.getExpFromIcon(r),className:"m-0 p-0"})),(0,t.jsx)(l.DropdownMenu,{appendToBody:!1,strategy:"fixed"},this.props.types.map(((e,s)=>(0,t.jsx)(l.DropdownItem,{onClick:t=>{this.onExpFromChange(e)},key:s,className:"text-default",a11yFocusBack:!1},(0,t.jsx)(l.Icon,{icon:this.getExpFromIcon(e),className:"mr-2"}),(0,t.jsx)("span",null,h(e,this.props.intl)))))))),(0,t.jsx)("div",{className:"flex-grow-1 expression-input"},p&&a?c?(0,t.jsx)("div",{className:"w-100 h-100 text-truncate ds-disabled d-flex align-items-center",onClick:this.toggleExpPopup},(0,t.jsx)("span",{className:"error-wrapper",title:c},c)):(0,t.jsx)("div",{className:"w-100 h-100 text-truncate ds-disabled ds-placeholder d-flex align-items-center",onClick:this.toggleExpPopup},(0,t.jsx)("span",{className:"error-wrapper",title:s[r]},s[r])):(0,t.jsx)("div",{className:"w-100 h-100",onClick:a?this.toggleExpPopup:void 0},(0,t.jsx)("div",{className:"w-100 h-100"},(0,t.jsx)(l.TextInput,{className:(0,t.classNames)("w-100 h-100",{"ds-disabled":a}),value:c,disabled:a,onChange:this.onInputChange,onBlur:this.onInputBlur,title:c,placeholder:s[r],"aria-label":this.props["aria-label"]}),a&&(0,t.jsx)("div",{className:"ds-disabled disabled-input-cover"}))))),o?(0,t.jsx)(Ke.ArcadeContentBuilderPopup,{widgetId:this.props.widgetId,useDataSources:this.props.useDataSources,onChange:this.onArcadeChange,dynamicStyleTypes:null,useTitle:!0,useIcons:!1,capabilities:[t.ArcadeContentCapability.Value],config:t.expressionUtils.getArcadeConfig(this.props.expression),isOpen:this.props.isExpPopupOpen,onClose:this.props.closeExpPopup,trigger:this.expBuilderTrigger.current,backToFocusNode:this.dropdownButton.current}):(0,t.jsx)(_e,Object.assign({},this.props,{expression:this.props.expression,onChange:this.onExpChange,types:this.getExpressionFrom(),isOpen:this.props.isExpPopupOpen,onClose:this.props.closeExpPopup,trigger:this.expBuilderTrigger.current,backToFocusNode:this.dropdownButton.current})))}}const Xe=(0,t.injectIntl)((0,a.withStyles)(Ge,"ExpressionInput"));(0,a.registerStyles)("jimu-ui/advanced/expression-builder/",e)})(),c})())}}}));