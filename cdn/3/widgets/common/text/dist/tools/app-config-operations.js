System.register(["jimu-core","jimu-ui"],(function(e,t){var i={},r={};return{setters:[function(e){i.Immutable=e.Immutable,i.arcadeContentUtils=e.arcadeContentUtils,i.dataSourceUtils=e.dataSourceUtils,i.dynamicStyleUtils=e.dynamicStyleUtils,i.expressionUtils=e.expressionUtils},function(e){r.richTextUtils=e.richTextUtils,r.utils=e.utils}],execute:function(){e((()=>{var e={14321:e=>{"use strict";e.exports=r},79244:e=>{"use strict";e.exports=i}},t={};function n(i){var r=t[i];if(void 0!==r)return r.exports;var s=t[i]={exports:{}};return e[i](s,s.exports,n),s.exports}n.d=(e,t)=>{for(var i in t)n.o(t,i)&&!n.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.p="";var s={};return n.p=window.jimuConfig.baseUrl,(()=>{"use strict";n.r(s),n.d(s,{default:()=>r,getExpressionsUseDataSources:()=>a,getReplacedDataSource:()=>d,mapArcadeForText:()=>S,mapExpressionForText:()=>x,mapExpressionForTooltip:()=>m,mapHtmlDataDsId:()=>U,mapLinks:()=>g,replaceExpressionDataSources:()=>u,replaceLinkExpressionDataSources:()=>p});var e=n(79244),t=n(14321);const i=(0,e.Immutable)([]);class r{constructor(){this.id="text-app-config-operation"}afterWidgetCopied(r,n,s,o,c){var l,a,d;if(!c)return o;const u=!!(null!==(l=n.widgets[r].useDataSources)&&void 0!==l?l:i).find((e=>c[e.mainDataSourceId])),p=n.widgets[r],U=null==p?void 0:p.config;let h=null!==(a=U.text)&&void 0!==a?a:"";const f=h&&t.richTextUtils.matchAll(h,t.richTextUtils.ARCADE_TAG_REGEXP).length>0;h=u?x(h,c,p):h,h=f?S(h,c,p):h,h=g(h,c,u,p);let E=o.setIn(["widgets",s,"config","text"],h),T=U.tooltip;T=u?m(T,c,p):T,T&&(E=E.setIn(["widgets",s,"config","tooltip"],T));let y=null===(d=U.style)||void 0===d?void 0:d.dynamicStyleConfig;return y&&(y=e.dynamicStyleUtils.getCopiedDynamicStyleConfig(c,p,(0,e.Immutable)(y)),E=E.setIn(["widgets",s,"config","style","dynamicStyleConfig"],y)),E}widgetWillRemove(e){return e}useDataSourceWillChange(t,i,r){var n,s,l,a;let d=t;const u=t.widgets[this.widgetId],p=u.config;if(i||r){const e=null!==(s=null===(n=u.useDataSources)||void 0===n?void 0:n.map((e=>e.dataSourceId)).asMutable())&&void 0!==s?s:[];let l=e.filter((e=>e!==i));r&&(l=l.concat(r));const a=c(p.text,l,e,this.widgetId,t);a&&(d=d.setIn(["widgets",this.widgetId,"config","text"],a));const g=o(p.tooltip,l,e,this.widgetId,t);g&&(d=d.setIn(["widgets",this.widgetId,"config","tooltip"],g))}if(null===(l=p.style)||void 0===l?void 0:l.enableDynamicStyle){const t=u.useDataSources,n=u.useDataSources.filter((e=>e.dataSourceId!==i)).concat(e.dataSourceUtils.getUseDataSourceByDataSourceId(r));let s=p;const o=e.dynamicStyleUtils.updateDynamicStyleWhenUseDataSourcesChange(this.id,t,n,(0,e.Immutable)(p.style.dynamicStyleConfig));s=o?s.setIn(["style","dynamicStyleConfig"],o):s.set("style",null===(a=s.style)||void 0===a?void 0:a.without("enableDynamicStyle").without("dynamicStyleConfig")),d=d.setIn(["widgets",this.widgetId,"config"],s)}return d}}const o=(t,i,r,n,s)=>{if(!(null==i?void 0:i.length)||!t)return;const o=l(t,i,r);if(!o)return;return e.expressionUtils.replaceDataSourceId(t,o[0],o[1],n,s)},c=(e,i,r,n,s)=>{if(!(null==i?void 0:i.length))return;const o=t.richTextUtils.getAllExpressions(e),c=a(o,i,r);return c?(e=u(e,c,n,s),e=p(e,c,n,s)):void 0},l=(t,i,r)=>{var n;const s=(null!==(n=e.expressionUtils.getUseDataSourcesByExpressionParts(t.parts))&&void 0!==n?n:(0,e.Immutable)([])).map((e=>e.dataSourceId)).asMutable();return d(s,i,r)},a=(e,t,i)=>{const r={};return Object.entries(e).forEach((([e,n])=>{const s=l(n,t,i);e&&s&&(r[e]=s)})),Object.keys(r).length?r:null},d=(t,i,r)=>{const n=[];return null==t||t.some((t=>{if(!i.includes(t)){const s=e.dataSourceUtils.isSelectionView(t),o=e.dataSourceUtils.getSortedDataViewIds(t).find((e=>i.includes(e)));if(o)if(s){r.find((t=>e.dataSourceUtils.isSelectionView(t)))&&n.push(t,o)}else n.push(t,o)}return!!n.length})),n.length?n:null},u=(i,r,n,s)=>i.replace(t.richTextUtils.EXP_TAG_REGEXP,(i=>{const o=t.richTextUtils.getUniqueId(i),c=r[o];return o&&c?(i=U(i,{[c[0]]:c[1]})).replace(t.richTextUtils.DATA_EXPRESSION_REGEXP,((i,r)=>{const o=t.richTextUtils.convertEncodeObject(r),l=e.expressionUtils.replaceDataSourceId((0,e.Immutable)(o),c[0],c[1],n,s);return`data-expression="${t.richTextUtils.convertEncodedString(l)}"`})):i})),p=(i,r,n,s)=>i.replace(t.richTextUtils.LINK_TAG_REGEXP,(i=>{const o=t.richTextUtils.getUniqueId(i);if(!o)return i;const c=r[o];return o&&c?(i=U(i,{[c[0]]:c[1]})).replace(t.richTextUtils.DATA_LINK_REGEXP,((i,r)=>{const o=t.richTextUtils.convertEncodeObject(r);if(!o.expression)return i;let l=(0,e.Immutable)(o);const a=e.expressionUtils.replaceDataSourceId(l.expression,c[0],c[1],n,s);l=l.set("expression",a);return`data-link="${t.richTextUtils.convertEncodedString(l)}"`})):i})),g=(i,r,n,s)=>i.replace(t.richTextUtils.LINK_TAG_REGEXP,(i=>t.richTextUtils.getUniqueId(i)?(i=n?U(i,r):i).replace(t.richTextUtils.DATA_LINK_REGEXP,((i,n)=>{const o=t.richTextUtils.convertEncodeObject(n),{isChanged:c,linkParam:l}=t.utils.mapLinkParam(r,(0,e.Immutable)(o),s);if(c){return`data-link="${t.richTextUtils.convertEncodedString(l)}"`}return i})):i)),x=(i,r,n)=>i.replace(t.richTextUtils.EXP_TAG_REGEXP,(i=>t.richTextUtils.getUniqueId(i)?(i=U(i,r)).replace(t.richTextUtils.DATA_EXPRESSION_REGEXP,((i,s)=>{const o=t.richTextUtils.convertEncodeObject(s),{isChanged:c,expression:l}=e.expressionUtils.mapExpression(r,(0,e.Immutable)(o),n);if(c){return`data-expression="${t.richTextUtils.convertEncodedString(l)}"`}return i})):i)),m=(t,i,r)=>{if(!t)return t;const{isChanged:n,expression:s}=e.expressionUtils.mapExpression(i,t,r);return n?(0,e.Immutable)(s):t};function U(i,r){return i.replace(t.richTextUtils.DATA_DS_ID_REGEXP,((t,i)=>{if(!i)return t;const n=i.split(",");let s="";return n.forEach((t=>{const i=Object.keys(r).find((i=>e.dataSourceUtils.areDerivedFromSameMain(t,i))),n=r[i],o=i&&n&&n!==i?t.replace(i,n):t;s+=`${s?",":""}${o}`})),s?`data-dsid="${s}"`:t}))}const S=(i,r,n)=>i.replace(t.richTextUtils.ARCADE_TAG_REGEXP,(i=>t.richTextUtils.getUniqueId(i)?(i=U(i,r)).replace(t.richTextUtils.DATA_ARCADE_REGEXP,((i,s)=>{const o=t.richTextUtils.convertEncodeObject(s),c=e.arcadeContentUtils.getCopiedArcadeContentConfig(r,n,(0,e.Immutable)(o));return`data-arcade="${t.richTextUtils.convertEncodedString(c)}"`})):i))})(),s})())}}}));