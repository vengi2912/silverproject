System.register(["jimu-core","jimu-for-builder","jimu-ui","jimu-ui/basic/imagecrop"],(function(t,e){var i={},o={},n={},r={};return{setters:[function(t){i.Immutable=t.Immutable,i.React=t.React,i.ReactDOM=t.ReactDOM,i.appActions=t.appActions,i.appConfigUtils=t.appConfigUtils,i.getAppStore=t.getAppStore},function(t){o.getAppConfigAction=t.getAppConfigAction},function(t){n.CropType=t.CropType},function(t){r.ImageCrop=t.ImageCrop}],execute:function(){t((()=>{var t={4108:t=>{"use strict";t.exports=o},14321:t=>{"use strict";t.exports=n},44456:t=>{"use strict";t.exports=r},79244:t=>{"use strict";t.exports=i}},e={};function s(i){var o=e[i];if(void 0!==o)return o.exports;var n=e[i]={exports:{}};return t[i](n,n.exports,s),n.exports}s.d=(t,e)=>{for(var i in e)s.o(e,i)&&!s.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:e[i]})},s.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),s.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},s.p="";var p={};return s.p=window.jimuConfig.baseUrl,(()=>{"use strict";s.r(p),s.d(p,{default:()=>r});var t=s(79244),e=s(4108),i=s(14321),o=s(44456);class n extends t.React.PureComponent{constructor(o){super(o),this.__unmount=!1,this.preloadImage=t=>{this.imgObject=new Image,this.imgObject.src=t,this.imgObject.onload=t=>{this.imgObject&&(this.__unmount||this.setState({imageWidth:this.imgObject.width,imageHeight:this.imgObject.height}))}},this.getCropZoomInCropTool=(t,e,i,o,n)=>{const r=t&&t.cropPixel,s=t&&t.cropZoom;let p=null,a=null,c=null,g=null;if(r&&s){const t=r.width,a=r.height;let l=null;e/i>=o/n?(c=e,g=n/o*c,e/i>=t/a?(l=e/(t*s),p=n*s*l/g):(l=i/(a*s),p=n*s*l/g)):(g=i,c=o/n*g,e/i>=t/a?(l=e/(t*s),p=n*s*l/g):(l=i/(a*s),p=n*s*l/g))}else e/i>=o/n?(c=e,g=n/o*c):(g=i,c=o/n*g),p=1;return a=c*p/o,a},this.getCropPositionInCropTool=(t,e)=>{const i=t&&t.cropPosition;return i?{x:e*i.x/t.cropZoom,y:e*i.y/t.cropZoom}:{x:0,y:0}},this.onCancelCrop=()=>{(0,t.getAppStore)().dispatch(t.appActions.setWidgetIsInlineEditingState(this.props.widgetId,!1))},this.onConfirmCrop=(o,n)=>{let r=this.props.config.functionConfig.imageParam;if(o.cropType===i.CropType.Real&&n&&(r=r.set("url",n.blobUrl).set("fileFormat",n.fileFormat)),r=r.set("cropParam",o),o.cropPixel){(0,t.getAppStore)().dispatch(t.appActions.setWidgetIsInlineEditingState(this.props.widgetId,!1));let i=(0,t.Immutable)(this.props.config.functionConfig);i=i.set("isCropped",!0),i=i.set("imageParam",r),(0,e.getAppConfigAction)().editWidgetConfig(this.props.widgetId,this.props.config.set("functionConfig",i)).exec()}},this.state={imageWidth:null,imageHeight:null,clientRect:{width:this.props.widgetWidth||0,height:this.props.widgetHeight||0,x:0,y:0,bottom:0,left:0,right:0,top:0,toJSON:()=>null}}}componentDidMount(){this.__unmount=!1;const e=t.appConfigUtils.processResourceUrl(this.props.config.functionConfig.imageParam.originalUrl);this.preloadImage(e);const i=document.querySelector(`.widget-renderer[data-widgetid='${this.props.widgetId}']`);i&&this.setState({clientRect:i.getBoundingClientRect()})}componentWillUnmount(){this.__unmount=!0,this.props.onUnmount&&this.props.onUnmount()}render(){const e=this.props.config.functionConfig.imageParam&&this.props.config.functionConfig.imageParam.cropParam,n=this.props.widgetWidth,r=this.props.widgetHeight;if(this.state.imageWidth&&this.state.imageHeight){const s=this.getCropZoomInCropTool(e,n,r,this.state.imageWidth,this.state.imageHeight),p=this.getCropPositionInCropTool(e,s),a=t.appConfigUtils.processResourceUrl(this.props.config.functionConfig.imageParam.originalUrl);return t.React.createElement(o.ImageCrop,{crop:p,cropZoom:s,imageFormat:this.props.config.functionConfig.imageParam.fileFormat,onCancelCrop:this.onCancelCrop,widgetArea:this.state.clientRect,cropParam:e,originId:this.props.config.functionConfig.imageParam.originalId,widgetId:this.props.widgetId,image:a,onConfirmCrop:this.onConfirmCrop,cropType:"BY_URL"===this.props.config.functionConfig.imageParam.imgSourceType?i.CropType.Fake:null})}return t.ReactDOM.createPortal(t.React.createElement("div",null,t.React.createElement("div",{className:"jimu-widget",style:{zIndex:9999,position:"fixed",top:0,left:0,backgroundColor:"rgb(0, 0, 0, .5)"}}),t.React.createElement("div",{style:{position:"absolute",left:"50%",top:"50%",zIndex:9999},className:"jimu-secondary-loading"})),document&&document.getElementsByTagName("body")[0])}}const r={WidgetInBuilder:n}})(),p})())}}}));